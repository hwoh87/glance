> [!TIP] 🗣️ 핵심내용
위젯 개발 중 발생하는 문제 해결 방법과 Preview를 활용한 효율적인 개발 방법을 소개합니다.
>

## 1. 디버깅 개요

Glance 위젯은 별도 프로세스에서 실행되고 RemoteViews로 변환되기 때문에 일반 앱보다 디버깅이 까다롭습니다. 효율적인 디버깅 전략이 필요합니다.

```
🐛 디버깅 난이도
앱 Activity: ★☆☆☆☆
Compose UI: ★★☆☆☆
Glance 위젯: ★★★★☆ ← 별도 프로세스, RemoteViews 변환
```

---

## 2. 로그 기반 디버깅

### 2.1 기본 로깅
```kotlin
class MyWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        Log.d("MyWidget", "provideGlance called for $id")

        provideContent {
            val prefs = currentState<Preferences>()
            val count = prefs[intPreferencesKey("count")] ?: 0

            Log.d("MyWidget", "Rendering with count: $count")

            Column {
                Text("Count: $count")
            }
        }
    }
}
```

### 2.2 상태 로깅 유틸리티
```kotlin
suspend fun logWidgetState(context: Context, glanceId: GlanceId, tag: String = "WidgetState") {
    val file = context.dataStoreFile("glance_${glanceId}")
    val dataStore = DataStoreFactory.create(PreferencesSerializer) { file }
    val prefs = dataStore.data.first()

    Log.d(tag, "=== Widget State for $glanceId ===")
    prefs.asMap().forEach { (key, value) ->
        Log.d(tag, "  ${key.name}: $value")
    }
    Log.d(tag, "================================")
}

// 사용 예시
class DebugAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        logWidgetState(context, glanceId)
    }
}
```

### 2.3 렌더링 파이프라인 추적
```kotlin
class TrackedWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        Log.d("TrackedWidget", "1. provideGlance START")

        val startTime = System.currentTimeMillis()

        provideContent {
            Log.d("TrackedWidget", "2. provideContent START")

            val prefs = currentState<Preferences>()
            Log.d("TrackedWidget", "3. State loaded: ${prefs.asMap().size} keys")

            val size = LocalSize.current
            Log.d("TrackedWidget", "4. Size: ${size.width} x ${size.height}")

            Column {
                Text("Debug Widget")
            }

            Log.d("TrackedWidget", "5. provideContent END")
        }

        val elapsed = System.currentTimeMillis() - startTime
        Log.d("TrackedWidget", "6. provideGlance END ($elapsed ms)")
    }
}
```

**[스크린샷 추천]** Logcat에서 위젯 로그 필터링한 화면

---

## 3. Preview 활용 (선택적)

Glance 위젯은 Preview를 제한적으로 지원합니다. 실기기에서 테스트하는 것이 가장 정확합니다.

---

## 4. 일반적인 문제와 해결책

### 4.1 위젯이 업데이트되지 않음

**문제**
```kotlin
// ❌ update() 호출 누락
class BadAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        updateAppWidgetState(context, glanceId) { prefs ->
            prefs[intPreferencesKey("count")] = 10
        }
        // update() 호출 안 함!
    }
}
```

**해결책**
```kotlin
// ✅ update() 호출 필수
class GoodAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        updateAppWidgetState(context, glanceId) { prefs ->
            prefs[intPreferencesKey("count")] = 10
        }
        MyWidget().update(context, glanceId) // 필수!
    }
}
```

---

### 4.2 위젯이 목록에 나타나지 않음

**체크리스트**
- [ ] AndroidManifest.xml에 receiver 등록됨?
- [ ] ProviderInfo XML 파일 존재함?
- [ ] initialLayout 리소스 존재함?
- [ ] minWidth, minHeight 설정됨?

```xml
<!-- AndroidManifest.xml -->
<receiver
    android:name=".MyWidgetReceiver"
    android:exported="true">
    <intent-filter>
        <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
    </intent-filter>
    <meta-data
        android:name="android.appwidget.provider"
        android:resource="@xml/my_widget_info" />
</receiver>

<!-- res/xml/my_widget_info.xml -->
<appwidget-provider
    android:initialLayout="@layout/placeholder"
    android:minWidth="180dp"
    android:minHeight="110dp"
    android:previewImage="@drawable/widget_preview"
    android:resizeMode="horizontal|vertical"
    android:widgetCategory="home_screen" />

<!-- res/layout/placeholder.xml -->
<TextView
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:text="Loading..."
    android:gravity="center" />
```

**[스크린샷 추천]** 위젯 선택 화면에서 위젯이 정상적으로 보이는 모습

---

### 4.3 Crash: "RemoteViews doesn't support..."

**문제**: Glance가 지원하지 않는 Compose 기능 사용

```kotlin
// ❌ 지원하지 않음
provideContent {
    var count by remember { mutableStateOf(0) } // remember 불가
    LaunchedEffect(Unit) { /* ... */ } // LaunchedEffect 불가
    Image(painter = /* Coil */, contentDescription = null) // Coil 직접 사용 불가
}
```

**해결책**: Glance 전용 API 사용
```kotlin
// ✅ 상태는 currentState() + updateAppWidgetState()
provideContent {
    val prefs = currentState<Preferences>()
    val count = prefs[intPreferencesKey("count")] ?: 0

    // 이미지는 리소스 또는 URI
    Image(
        provider = ImageProvider(R.drawable.icon),
        contentDescription = "Icon"
    )
}
```

---

### 4.4 여러 위젯 인스턴스가 같은 상태 공유

**문제**: GlanceId를 무시하고 전역 상태 사용

```kotlin
// ❌ 모든 인스턴스가 같은 값을 보여줌
class BadWidget : GlanceAppWidget() {
    companion object {
        var globalCount = 0 // 공유 변수
    }

    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            Text("Count: $globalCount")
        }
    }
}
```

**해결책**: GlanceId별 상태 관리
```kotlin
// ✅ 각 인스턴스가 독립적인 상태
class GoodWidget : GlanceAppWidget() {
    override val stateDefinition = PreferencesGlanceStateDefinition

    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            val prefs = currentState<Preferences>()
            val count = prefs[intPreferencesKey("count")] ?: 0
            Text("Count: $count")
        }
    }
}
```

**[비디오 추천]** 같은 위젯 3개를 추가하고 각각 독립적으로 동작하는 모습

---

## 5. 테스트 전략

### 5.1 Unit Test: StateDefinition
```kotlin
@Test
fun `위젯 상태 저장 및 로드 테스트`() = runTest {
    val context = ApplicationProvider.getApplicationContext<Context>()
    val testGlanceId = AppWidgetId(12345)

    // 상태 저장
    updateAppWidgetState(context, testGlanceId) { prefs ->
        prefs[intPreferencesKey("count")] = 42
        prefs[stringPreferencesKey("name")] = "Test"
    }

    // 상태 로드
    val file = context.dataStoreFile("glance_$testGlanceId")
    val dataStore = DataStoreFactory.create(PreferencesSerializer) { file }
    val prefs = dataStore.data.first()

    assertEquals(42, prefs[intPreferencesKey("count")])
    assertEquals("Test", prefs[stringPreferencesKey("name")])
}
```

### 5.2 Unit Test: ActionCallback
```kotlin
@Test
fun `IncrementAction 테스트`() = runTest {
    val context = ApplicationProvider.getApplicationContext<Context>()
    val testGlanceId = AppWidgetId(12345)

    // 초기 상태
    updateAppWidgetState(context, testGlanceId) { prefs ->
        prefs[intPreferencesKey("count")] = 0
    }

    // Action 실행
    val action = IncrementAction()
    action.onAction(context, testGlanceId, ActionParameters.Empty)

    // 결과 확인
    val file = context.dataStoreFile("glance_$testGlanceId")
    val dataStore = DataStoreFactory.create(PreferencesSerializer) { file }
    val prefs = dataStore.data.first()

    assertEquals(1, prefs[intPreferencesKey("count")])
}
```

### 5.3 Integration Test
```kotlin
@RunWith(AndroidJUnit4::class)
class WidgetIntegrationTest {
    @get:Rule
    val composeTestRule = createComposeRule()

    @Test
    fun `위젯 전체 플로우 테스트`() {
        // 1. 위젯 추가
        val appWidgetId = addWidget()

        // 2. 상태 확인
        val glanceId = GlanceAppWidgetManager(context)
            .getGlanceIdBy(appWidgetId)

        val prefs = getWidgetState(glanceId)
        assertEquals(0, prefs[intPreferencesKey("count")])

        // 3. Action 실행
        performClick(glanceId, IncrementAction::class.java)

        // 4. 업데이트된 상태 확인
        val updatedPrefs = getWidgetState(glanceId)
        assertEquals(1, updatedPrefs[intPreferencesKey("count")])
    }
}
```

---

## 6. 개발 워크플로우 권장사항

### 6.1 빠른 반복 개발
```
1. Preview로 UI 초안 작성 (빠름)
2. 에뮬레이터/실기기에서 실제 위젯 테스트
3. Logcat으로 동작 확인
4. 필요시 Unit Test 작성
```

### 6.2 디버그 빌드 전용 기능
```kotlin
class DebugWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            Column {
                if (BuildConfig.DEBUG) {
                    Text("GlanceId: $id", style = TextStyle(fontSize = 10.sp))
                    Text("Size: ${LocalSize.current}", style = TextStyle(fontSize = 10.sp))
                    Button("Log State", onClick = actionRunCallback<LogStateAction>())
                }

                // 실제 위젯 UI
                MainWidgetContent()
            }
        }
    }
}
```

**[스크린샷 추천]** 디버그 정보가 표시된 위젯 (GlanceId, Size 등)

---

---
