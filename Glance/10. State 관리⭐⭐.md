> [!TIP] ğŸ—£ï¸ í•µì‹¬ë‚´ìš©
ìœ„ì ¯ì˜ ìƒíƒœë¥¼ ì €ì¥í•˜ê³  ë³µì›í•˜ëŠ” ë°©ë²•. `currentState()`, `updateAll()`, `update()`ë¥¼ í™œìš©í•œ ë°ì´í„° ê´€ë¦¬ë¥¼ ë°°ì›ë‹ˆë‹¤.
>

## 1. State ê´€ë¦¬ ê°œìš”

Glance ìœ„ì ¯ì€ **ì¸ìŠ¤í„´ìŠ¤ë³„ë¡œ ë…ë¦½ì ì¸ ìƒíƒœ**ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í™ˆ í™”ë©´ì— ê°™ì€ ìœ„ì ¯ì„ ì—¬ëŸ¬ ê°œ ì¶”ê°€í•˜ë©´ ê°ê° ë‹¤ë¥¸ ë°ì´í„°ë¥¼ ë³´ì—¬ì¤„ ìˆ˜ ìˆë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.

```
ğŸ“± í™ˆ í™”ë©´
   â”œâ”€ ìœ„ì ¯ A (`GlanceId`: 123) â†’ State A
   â”œâ”€ ìœ„ì ¯ B (`GlanceId`: 456) â†’ State B
   â””â”€ ìœ„ì ¯ C (`GlanceId`: 789) â†’ State C
```

### 1.1 ì „í†µ ìœ„ì ¯ê³¼ì˜ ìƒíƒœ ê´€ë¦¬ ë¹„êµ

**ì „í†µ ìœ„ì ¯ (SharedPreferences ì§ì ‘ êµ¬í˜„)**
```kotlin
class TraditionalWidget : AppWidgetProvider() {
    override fun onUpdate(
        context: Context,
        appWidgetManager: AppWidgetManager,
        appWidgetIds: IntArray
    ) {
        appWidgetIds.forEach { appWidgetId ->
            // 1. SharedPreferencesì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ìƒíƒœ ì½ê¸°
            val prefs = context.getSharedPreferences("widget_$appWidgetId", Context.MODE_PRIVATE)
            val count = prefs.getInt("count", 0)
            val name = prefs.getString("name", "Guest") ?: "Guest"

            // 2. RemoteViews ìƒì„± ë° ì„¤ì •
            val views = RemoteViews(context.packageName, R.layout.widget_layout)
            views.setTextViewText(R.id.count_text, "Count: $count")
            views.setTextViewText(R.id.name_text, "Name: $name")

            // 3. ë²„íŠ¼ í´ë¦­ ì‹œ BroadcastReceiverë¡œ ì „ë‹¬
            val intent = Intent(context, IncrementReceiver::class.java)
            intent.putExtra("widget_id", appWidgetId)
            val pendingIntent = PendingIntent.getBroadcast(
                context, appWidgetId, intent, PendingIntent.FLAG_UPDATE_CURRENT
            )
            views.setOnClickPendingIntent(R.id.increment_button, pendingIntent)

            appWidgetManager.updateAppWidget(appWidgetId, views)
        }
    }
}

// ë³„ë„ BroadcastReceiverë¡œ ìƒíƒœ ë³€ê²½ ì²˜ë¦¬
class IncrementReceiver : BroadcastReceiver() {
    override fun onReceive(context: Context, intent: Intent) {
        val widgetId = intent.getIntExtra("widget_id", -1)

        // 1. SharedPreferencesì—ì„œ ì½ê¸°
        val prefs = context.getSharedPreferences("widget_$widgetId", Context.MODE_PRIVATE)
        val currentCount = prefs.getInt("count", 0)

        // 2. ìƒíƒœ ë³€ê²½
        prefs.edit().putInt("count", currentCount + 1).apply()

        // 3. ìœ„ì ¯ ìˆ˜ë™ ì—…ë°ì´íŠ¸
        val appWidgetManager = AppWidgetManager.getInstance(context)
        val views = RemoteViews(context.packageName, R.layout.widget_layout)
        views.setTextViewText(R.id.count_text, "Count: ${currentCount + 1}")
        appWidgetManager.updateAppWidget(widgetId, views)
    }
}
```

**ë¬¸ì œì **:
- SharedPreferences íŒŒì¼ëª… ê´€ë¦¬ (`widget_$appWidgetId`)ë¥¼ ì§ì ‘ í•´ì•¼ í•¨
- ìƒíƒœ ì½ê¸°/ì“°ê¸° ë¡œì§ì´ ì—¬ëŸ¬ ê³³ì— ë¶„ì‚° (AppWidgetProvider, BroadcastReceiver ë“±)
- ì¸ìŠ¤í„´ìŠ¤ë³„ ìƒíƒœ ë¶„ë¦¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ êµ¬í˜„í•´ì•¼ í•¨
- íƒ€ì… ì•ˆì •ì„± ë¶€ì¡± (ë¬¸ìì—´ í‚¤ ì‚¬ìš©)
- ìƒíƒœ ë³€ê²½ í›„ UI ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬

**Glance ìœ„ì ¯ (DataStore ê¸°ë°˜ StateDefinition)**
```kotlin
class ModernWidget : GlanceAppWidget() {
    // StateDefinition ì§€ì •ë§Œìœ¼ë¡œ ìƒíƒœ ê´€ë¦¬ ì¤€ë¹„ ì™„ë£Œ
    override val stateDefinition = PreferencesGlanceStateDefinition

    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            // 1. ìƒíƒœ ì½ê¸° - ì¸ìŠ¤í„´ìŠ¤ë³„ ìë™ ë¶„ë¦¬
            val prefs = currentState<Preferences>()
            val count = prefs[intPreferencesKey("count")] ?: 0
            val name = prefs[stringPreferencesKey("name")] ?: "Guest"

            Column {
                Text("Count: $count")
                Text("Name: $name")

                // 2. ë²„íŠ¼ í´ë¦­ ì‹œ ActionCallbackìœ¼ë¡œ ì²˜ë¦¬
                Button(
                    text = "Increment",
                    onClick = actionRunCallback<IncrementAction>()
                )
            }
        }
    }
}

// ìƒíƒœ ë³€ê²½ ë¡œì§ - íƒ€ì… ì•ˆì •ì„± ë³´ì¥
class IncrementAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // 1. ìƒíƒœ ë³€ê²½ - ì¸ìŠ¤í„´ìŠ¤ë³„ ìë™ ê´€ë¦¬
        updateAppWidgetState(context, glanceId) { prefs ->
            val current = prefs[intPreferencesKey("count")] ?: 0
            prefs[intPreferencesKey("count")] = current + 1
        }

        // 2. UI ì—…ë°ì´íŠ¸ - í•œ ì¤„ë¡œ ì²˜ë¦¬
        ModernWidget().update(context, glanceId)
    }
}
```

**ê°œì„ ì **:
- **ì¸ìŠ¤í„´ìŠ¤ë³„ ìƒíƒœ ìë™ ê´€ë¦¬**: GlanceId ê¸°ë°˜ìœ¼ë¡œ ìë™ ë¶„ë¦¬
- **DataStore ê¸°ë°˜**: SharedPreferencesë³´ë‹¤ ì•ˆì „í•˜ê³  ë¹„ë™ê¸° ì¹œí™”ì 
- **íƒ€ì… ì•ˆì •ì„±**: `intPreferencesKey`, `stringPreferencesKey` ë“±ìœ¼ë¡œ íƒ€ì… ë³´ì¥
- **ì¤‘ì•™í™”ëœ ë¡œì§**: ìƒíƒœ ê´€ë¦¬ê°€ `updateAppWidgetState` + `update()`ë¡œ í†µì¼
- **ì½”ë“œ ê°„ê²°ì„±**: ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ ëŒ€í­ ê°ì†Œ

**ë¹„êµ ìš”ì•½**:

| í•­ëª© | ì „í†µ ìœ„ì ¯ | Glance ìœ„ì ¯ |
|------|-----------|-------------|
| **ìƒíƒœ ì €ì¥ì†Œ** | SharedPreferences (ì§ì ‘ êµ¬í˜„) | DataStore (ìë™ ì œê³µ) |
| **ì¸ìŠ¤í„´ìŠ¤ ë¶„ë¦¬** | `widget_$appWidgetId` íŒŒì¼ëª… ìˆ˜ë™ ê´€ë¦¬ | `GlanceId` ìë™ ê´€ë¦¬ |
| **íƒ€ì… ì•ˆì •ì„±** | ë¬¸ìì—´ í‚¤ (íƒ€ì… ë¶ˆì•ˆì •) | Typed Key (íƒ€ì… ì•ˆì •) |
| **ìƒíƒœ ë³€ê²½ íë¦„** | ì½ê¸° â†’ ë³€ê²½ â†’ ì €ì¥ â†’ UI ì—…ë°ì´íŠ¸ (4ë‹¨ê³„) | `updateAppWidgetState` + `update()` (2ë‹¨ê³„) |
| **ì½”ë“œ ë¶„ì‚°** | AppWidgetProvider, BroadcastReceiver ë“± ì—¬ëŸ¬ ê³³ | ActionCallback í•œ ê³³ì— ì§‘ì¤‘ |
| **ë¹„ë™ê¸° ì§€ì›** | ìˆ˜ë™ êµ¬í˜„ í•„ìš” | Coroutine ê¸°ë°˜ ìë™ ì§€ì› |

---

## 2. `StateDefinition` ì¢…ë¥˜

### 2.1 `PreferencesGlanceStateDefinition` (ê°€ì¥ ë§ì´ ì‚¬ìš©)
- **ê°„ë‹¨í•œ key-value ë°ì´í„°**ì— ì í•©
- DataStore Preferences ê¸°ë°˜
- íƒ€ì…: `Int`, `String`, `Boolean`, `Long`, `Float`, `Double`, `Set<String>`

```kotlin
class SimpleWidget : GlanceAppWidget() {
    // StateDefinition ì§€ì •
    override val stateDefinition = PreferencesGlanceStateDefinition

    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            // 1. í˜„ì¬ ìƒíƒœ ì½ê¸°
            val prefs = currentState<Preferences>()
            val count = prefs[intPreferencesKey("count")] ?: 0
            val name = prefs[stringPreferencesKey("name")] ?: "Guest"
            val isActive = prefs[booleanPreferencesKey("is_active")] ?: false

            Column {
                Text("Count: $count")
                Text("Name: $name")
                Text("Active: $isActive")
            }
        }
    }
}
```

---

### 2.2 `ProtoGlanceStateDefinition` (ë³µì¡í•œ ë°ì´í„°)
- **êµ¬ì¡°í™”ëœ ë°ì´í„°**ì— ì í•©
- Protocol Buffers ì‚¬ìš©
- íƒ€ì… ì•ˆì •ì„± â†‘, ì§ë ¬í™” ì„±ëŠ¥ â†‘

**Step 1: proto íŒŒì¼ ì •ì˜**
```protobuf
// app/src/main/proto/widget_state.proto
syntax = "proto3";

option java_package = "com.example.widget";
option java_multiple_files = true;

message WidgetState {
    string title = 1;
    int32 counter = 2;
    repeated string items = 3;
}
```

**Step 2: build.gradle.kts ì„¤ì •**
```kotlin
plugins {
    id("com.google.protobuf") version "0.9.4"
}

dependencies {
    implementation("androidx.datastore:datastore:1.0.0")
    implementation("com.google.protobuf:protobuf-javalite:3.21.12")
}

protobuf {
    protoc {
        artifact = "com.google.protobuf:protoc:3.21.12"
    }
    generateProtoTasks {
        all().forEach { task ->
            task.builtins {
                create("java") {
                    option("lite")
                }
            }
        }
    }
}
```

**Step 3: StateDefinition êµ¬í˜„**
```kotlin
object WidgetStateDefinition : GlanceStateDefinition<WidgetState> {
    private const val DATA_STORE_FILENAME = "widget_state"

    override suspend fun getDataStore(context: Context, fileKey: String): DataStore<WidgetState> {
        return context.dataStore
    }

    override fun getLocation(context: Context, fileKey: String): File {
        return context.dataStoreFile("$DATA_STORE_FILENAME$fileKey")
    }

    private val Context.dataStore by dataStore(
        fileName = DATA_STORE_FILENAME,
        serializer = WidgetStateSerializer
    )
}

object WidgetStateSerializer : Serializer<WidgetState> {
    override val defaultValue: WidgetState = WidgetState.getDefaultInstance()

    override suspend fun readFrom(input: InputStream): WidgetState {
        return WidgetState.parseFrom(input)
    }

    override suspend fun writeTo(t: WidgetState, output: OutputStream) {
        t.writeTo(output)
    }
}

// Widgetì—ì„œ ì‚¬ìš©
class ProtoWidget : GlanceAppWidget() {
    override val stateDefinition = WidgetStateDefinition

    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            val state = currentState<WidgetState>()
            Column {
                Text("Title: ${state.title}")
                Text("Counter: ${state.counter}")
                state.itemsList.forEach { item ->
                    Text("- $item")
                }
            }
        }
    }
}
```

---

### 2.3 Custom StateDefinition
- íŠ¹ìˆ˜í•œ ìš”êµ¬ì‚¬í•­ì´ ìˆì„ ë•Œ ì§ì ‘ êµ¬í˜„
- Room, File, Network ë“± ì™¸ë¶€ ì†ŒìŠ¤ í™œìš© ê°€ëŠ¥

```kotlin
object RoomStateDefinition : GlanceStateDefinition<WidgetData> {
    override suspend fun getDataStore(
        context: Context,
        fileKey: String
    ): DataStore<WidgetData> {
        // Roomì´ë‚˜ ë‹¤ë¥¸ ì €ì¥ì†Œì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        return CustomDataStore(context, fileKey)
    }

    override fun getLocation(context: Context, fileKey: String): File {
        return File(context.filesDir, "room_state_$fileKey")
    }
}
```

---

## 3. ìƒíƒœ ì½ê¸°

### 3.1 currentState()
```kotlin
override suspend fun provideGlance(context: Context, id: GlanceId) {
    provideContent {
        // Preferences ë°©ì‹
        val prefs = currentState<Preferences>()
        val value = prefs[intPreferencesKey("my_key")] ?: 0

        // Proto ë°©ì‹
        val state = currentState<WidgetState>()
        val title = state.title

        Text("Value: $value, Title: $title")
    }
}
```

> [!NOTE] ğŸ’¬ ë°œí‘œ ì„¤ëª…
> "`currentState()`ëŠ” ìœ„ì ¯ì˜ í˜„ì¬ ìƒíƒœë¥¼ ì½ì–´ì˜¤ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
>
> Preferences ë°©ì‹ì„ ì“°ë©´ `Preferences` íƒ€ì…ì„ ë°›ê³ , `intPreferencesKey`ë‚˜ `stringPreferencesKey`ë¡œ ê°’ì„ êº¼ëƒ…ë‹ˆë‹¤. Proto ë°©ì‹ì€ ì§ì ‘ ì •ì˜í•œ ë°ì´í„° í´ë˜ìŠ¤ë¥¼ ë°›ì•„ì„œ í”„ë¡œí¼í‹°ë¡œ ì ‘ê·¼í•©ë‹ˆë‹¤.
>
> ì¤‘ìš”í•œ ê±´, ì´ ìƒíƒœëŠ” **ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ë³„ë¡œ ë…ë¦½ì **ì´ë¼ëŠ” ì ì…ë‹ˆë‹¤. ê°™ì€ ìœ„ì ¯ì„ 3ê°œ ì¶”ê°€í•˜ë©´ ê°ê° ë‹¤ë¥¸ `GlanceId`ë¥¼ ê°–ê³ , ê°ìì˜ ìƒíƒœë¥¼ ë”°ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
>
> Composeì˜ `remember`ì™€ ë¹„ìŠ·í•˜ì§€ë§Œ, DataStore ê¸°ë°˜ì´ë¼ **í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ í›„ì—ë„ ìœ ì§€**ë©ë‹ˆë‹¤."

---

## 4. ìƒíƒœ ì“°ê¸°

### 4.1 updateAppWidgetState (ë‹¨ì¼ ìœ„ì ¯)
```kotlin
class IncrementAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // Preferences ë°©ì‹
        updateAppWidgetState(context, glanceId) { prefs ->
            val current = prefs[intPreferencesKey("count")] ?: 0
            prefs[intPreferencesKey("count")] = current + 1
        }

        // Proto ë°©ì‹ (ë³µì‚¬ í›„ ìˆ˜ì •)
        updateAppWidgetState(context, glanceId) { state: WidgetState ->
            state.toBuilder()
                .setCounter(state.counter + 1)
                .build()
        }

        // ë°˜ë“œì‹œ update() í˜¸ì¶œ!
        MyWidget().update(context, glanceId)
    }
}
```

> [!NOTE] ğŸ’¬ ë°œí‘œ ì„¤ëª…
> "ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” íë¦„ì€ **2ë‹¨ê³„**ì…ë‹ˆë‹¤.
>
> 1. **`updateAppWidgetState`ë¡œ ìƒíƒœ ë³€ê²½**: ëŒë‹¤ ì•ˆì—ì„œ ê¸°ì¡´ ê°’ì„ ì½ê³ , ìƒˆ ê°’ì„ ì„¤ì •í•©ë‹ˆë‹¤. Preferences ë°©ì‹ì€ mutableí•˜ê²Œ ì§ì ‘ ìˆ˜ì •í•˜ê³ , Proto ë°©ì‹ì€ ë¶ˆë³€ ê°ì²´ë¼ì„œ ë¹Œë”ë¡œ ë³µì‚¬ í›„ ìˆ˜ì •í•©ë‹ˆë‹¤.
>
> 2. **`update()` í˜¸ì¶œë¡œ UI ê°±ì‹ **: ìƒíƒœë§Œ ë°”ê¿”ì„œëŠ” í™”ë©´ì´ ì•ˆ ë°”ë€ë‹ˆë‹¤. ë°˜ë“œì‹œ `MyWidget().update(context, glanceId)`ë¥¼ í˜¸ì¶œí•´ì•¼ `provideContent`ê°€ ë‹¤ì‹œ ì‹¤í–‰ë˜ê³  UIê°€ ìƒˆë¡œ ê·¸ë ¤ì§‘ë‹ˆë‹¤.
>
> ì´ ë‘ ë‹¨ê³„ë¥¼ ë¹¼ë¨¹ìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤. ìƒíƒœëŠ” ë°”ë€Œì—ˆëŠ”ë° í™”ë©´ì€ ê·¸ëŒ€ë¡œê±°ë‚˜, ìƒíƒœëŠ” ê·¸ëŒ€ë¡œì¸ë° UIë§Œ ë‹¤ì‹œ ê·¸ë ¤ì§€ëŠ” ìƒí™©ì´ ìƒê¸¸ ìˆ˜ ìˆì–´ìš”."

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** ìƒíƒœ ë³€ê²½ ì „í›„ ë¹„êµ (ì¹´ìš´í„° 0 â†’ 1)

---

### 4.2 updateAll (ëª¨ë“  ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤)
```kotlin
class RefreshAllAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // ëª¨ë“  ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ì˜ ìƒíƒœë¥¼ ë™ì¼í•˜ê²Œ ë³€ê²½
        val manager = GlanceAppWidgetManager(context)
        val glanceIds = manager.getGlanceIds(MyWidget::class.java)

        glanceIds.forEach { id ->
            updateAppWidgetState(context, id) { prefs ->
                prefs[longPreferencesKey("last_sync")] = System.currentTimeMillis()
            }
        }

        // ëª¨ë“  ìœ„ì ¯ UI ê°±ì‹ 
        MyWidget().updateAll(context)
    }
}
```

---

## 5. ì‹¤ì „ íŒ¨í„´

### 5.1 ì´ˆê¸° ìƒíƒœ ì„¤ì •
```kotlin
class MyWidgetReceiver : GlanceAppWidgetReceiver() {
    override val glanceAppWidget = MyWidget()

    override fun onUpdate(
        context: Context,
        appWidgetManager: AppWidgetManager,
        appWidgetIds: IntArray
    ) {
        super.onUpdate(context, appWidgetManager, appWidgetIds)

        // ê° ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ì— ì´ˆê¸° ìƒíƒœ ì„¤ì •
        appWidgetIds.forEach { appWidgetId ->
            val glanceId = GlanceAppWidgetManager(context)
                .getGlanceIdBy(appWidgetId)

            lifecycleScope.launch {
                updateAppWidgetState(context, glanceId) { prefs ->
                    if (!prefs.contains(intPreferencesKey("count"))) {
                        prefs[intPreferencesKey("count")] = 0
                    }
                    prefs[longPreferencesKey("created_at")] = System.currentTimeMillis()
                }
                MyWidget().update(context, glanceId)
            }
        }
    }
}
```

---

### 5.2 ì™¸ë¶€ ë°ì´í„°ì™€ ë™ê¸°í™” (Repository íŒ¨í„´)
```kotlin
class DataSyncWorker(
    context: Context,
    params: WorkerParameters
) : CoroutineWorker(context, params) {

    override suspend fun doWork(): Result {
        // 1. API í˜¸ì¶œ
        val data = apiService.fetchData()

        // 2. ëª¨ë“  ìœ„ì ¯ ìƒíƒœ ì—…ë°ì´íŠ¸
        val manager = GlanceAppWidgetManager(applicationContext)
        val glanceIds = manager.getGlanceIds(MyWidget::class.java)

        glanceIds.forEach { glanceId ->
            updateAppWidgetState(applicationContext, glanceId) { prefs ->
                prefs[stringPreferencesKey("data")] = data.toString()
                prefs[longPreferencesKey("last_update")] = System.currentTimeMillis()
            }
        }

        // 3. UI ê°±ì‹ 
        MyWidget().updateAll(applicationContext)

        return Result.success()
    }
}
```

**[ë¹„ë””ì˜¤ ì¶”ì²œ]** Worker ì‹¤í–‰ â†’ API í˜¸ì¶œ â†’ ìœ„ì ¯ ìƒíƒœ ë³€ê²½ â†’ UI ìë™ ê°±ì‹  íë¦„

---

### 5.3 ì¡°ê±´ë¶€ ìƒíƒœ ë³€ê²½
```kotlin
class ToggleAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        updateAppWidgetState(context, glanceId) { prefs ->
            val isEnabled = prefs[booleanPreferencesKey("is_enabled")] ?: false

            if (isEnabled) {
                // ë¹„í™œì„±í™”
                prefs[booleanPreferencesKey("is_enabled")] = false
                prefs[stringPreferencesKey("status")] = "OFF"
            } else {
                // í™œì„±í™”
                prefs[booleanPreferencesKey("is_enabled")] = true
                prefs[stringPreferencesKey("status")] = "ON"
                prefs[longPreferencesKey("enabled_at")] = System.currentTimeMillis()
            }
        }

        MyWidget().update(context, glanceId)
    }
}
```

---

### 5.4 ìƒíƒœ ê¸°ë°˜ UI ë¶„ê¸°
```kotlin
override suspend fun provideGlance(context: Context, id: GlanceId) {
    provideContent {
        val prefs = currentState<Preferences>()
        val status = prefs[stringPreferencesKey("status")] ?: "idle"

        when (status) {
            "loading" -> LoadingUI()
            "success" -> SuccessUI(prefs)
            "error" -> ErrorUI(prefs[stringPreferencesKey("error_msg")])
            else -> IdleUI()
        }
    }
}

@Composable
fun LoadingUI() {
    Box(
        modifier = GlanceModifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        CircularProgressIndicator()
        Text("ë¡œë”© ì¤‘...")
    }
}

@Composable
fun SuccessUI(prefs: Preferences) {
    val data = prefs[stringPreferencesKey("data")] ?: ""
    Column {
        Text("ì„±ê³µ!", style = TextStyle(fontWeight = FontWeight.Bold))
        Text(data)
    }
}

@Composable
fun ErrorUI(message: String?) {
    Column {
        Text("ì˜¤ë¥˜ ë°œìƒ", style = TextStyle(color = ColorProvider(Color.Red)))
        Text(message ?: "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜")
        Button("ì¬ì‹œë„", onClick = actionRunCallback<RetryAction>())
    }
}
```

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** ìƒíƒœë³„ UI ë³€í™” (idle, loading, success, error)

---

## 6. ìƒíƒœ ë””ë²„ê¹…

### 6.1 í˜„ì¬ ìƒíƒœ ë¡œê¹…
```kotlin
class DebugAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        val prefs = context
            .dataStoreFile("glance_${glanceId}")
            .let { DataStoreFactory.create(PreferencesSerializer, it) }
            .data
            .first()

        Log.d("WidgetState", "GlanceId: $glanceId")
        prefs.asMap().forEach { (key, value) ->
            Log.d("WidgetState", "  $key = $value")
        }
    }
}
```

### 6.2 ìƒíƒœ ì´ˆê¸°í™” (í…ŒìŠ¤íŠ¸ìš©)
```kotlin
class ResetAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        updateAppWidgetState(context, glanceId) { prefs ->
            prefs.clear()
            // ê¸°ë³¸ê°’ ì¬ì„¤ì •
            prefs[intPreferencesKey("count")] = 0
            prefs[stringPreferencesKey("status")] = "idle"
        }

        MyWidget().update(context, glanceId)
    }
}
```

---

## 7. ìƒíƒœ ê´€ë¦¬ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### âœ… DO
- **ì‘ì€ ë°ì´í„°ë§Œ ì €ì¥** (ìˆ˜ì‹­ KB ì´ë‚´)
- **ìƒíƒœ ë³€ê²½ í›„ ì¦‰ì‹œ update() í˜¸ì¶œ**
- **ê¸°ë³¸ê°’ ì œê³µ** (?: 0, ?: "default")
- **ì¸ìŠ¤í„´ìŠ¤ë³„ ë…ë¦½ì„± ìœ ì§€** (GlanceId í™œìš©)
- **ë¬´ê±°ìš´ ë°ì´í„°ëŠ” ì™¸ë¶€ ì €ì¥ì†Œ**(Room, File) + Glanceì—ëŠ” IDë§Œ ì €ì¥

### âŒ DON'T
- **ëŒ€ìš©ëŸ‰ ë°ì´í„° ì €ì¥ ê¸ˆì§€** (ì´ë¯¸ì§€, ê¸´ í…ìŠ¤íŠ¸)
- **ìƒíƒœ ë³€ê²½ë§Œ í•˜ê³  update() ìƒëµ**
- **ë™ê¸°í™” ë¸”ë¡œí‚¹ ì‘ì—…** (ë„¤íŠ¸ì›Œí¬, DB)
- **ìƒíƒœì— ë¯¼ê° ì •ë³´ ì €ì¥** (í† í°, ë¹„ë°€ë²ˆí˜¸)

---

## 8. ì‹¤ì „ ì˜ˆì œ: ë‚ ì”¨ ìœ„ì ¯

```kotlin
data class WeatherData(
    val temperature: Int,
    val condition: String,
    val lastUpdate: Long
)

class WeatherWidget : GlanceAppWidget() {
    override val stateDefinition = PreferencesGlanceStateDefinition

    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            val prefs = currentState<Preferences>()
            val temp = prefs[intPreferencesKey("temperature")] ?: 0
            val condition = prefs[stringPreferencesKey("condition")] ?: "ì•Œ ìˆ˜ ì—†ìŒ"
            val isLoading = prefs[booleanPreferencesKey("is_loading")] ?: false
            val lastUpdate = prefs[longPreferencesKey("last_update")] ?: 0L

            Column(
                modifier = GlanceModifier
                    .fillMaxSize()
                    .padding(16.dp)
                    .background(Color.LightGray)
            ) {
                if (isLoading) {
                    Text("ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ì¤‘...")
                    CircularProgressIndicator()
                } else {
                    Text("ğŸŒ¤ï¸ $condition", style = TextStyle(fontSize = 24.sp))
                    Text("$tempÂ°C", style = TextStyle(fontSize = 48.sp, fontWeight = FontWeight.Bold))

                    Spacer(GlanceModifier.height(8.dp))

                    Text(
                        "ìµœê·¼ ì—…ë°ì´íŠ¸: ${formatTime(lastUpdate)}",
                        style = TextStyle(fontSize = 12.sp, color = ColorProvider(Color.Gray))
                    )
                }

                Spacer(GlanceModifier.defaultWeight())

                Button(
                    text = "ìƒˆë¡œê³ ì¹¨",
                    onClick = actionRunCallback<RefreshWeatherAction>(),
                    modifier = GlanceModifier.fillMaxWidth()
                )
            }
        }
    }
}

class RefreshWeatherAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // 1. ë¡œë”© ìƒíƒœë¡œ ë³€ê²½
        updateAppWidgetState(context, glanceId) { prefs ->
            prefs[booleanPreferencesKey("is_loading")] = true
        }
        WeatherWidget().update(context, glanceId)

        // 2. Workerë¡œ ë‚ ì”¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë¹„ë™ê¸°)
        val workRequest = OneTimeWorkRequestBuilder<WeatherWorker>()
            .setInputData(workDataOf("glance_id" to glanceId.toString()))
            .build()
        WorkManager.getInstance(context).enqueue(workRequest)
    }
}

class WeatherWorker(context: Context, params: WorkerParameters) : CoroutineWorker(context, params) {
    override suspend fun doWork(): Result {
        val glanceIdString = inputData.getString("glance_id") ?: return Result.failure()
        val glanceId = GlanceAppWidgetManager(applicationContext)
            .getGlanceIds(WeatherWidget::class.java)
            .find { it.toString() == glanceIdString }
            ?: return Result.failure()

        try {
            // API í˜¸ì¶œ
            val weather = weatherApi.getCurrentWeather()

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            updateAppWidgetState(applicationContext, glanceId) { prefs ->
                prefs[intPreferencesKey("temperature")] = weather.temp
                prefs[stringPreferencesKey("condition")] = weather.condition
                prefs[longPreferencesKey("last_update")] = System.currentTimeMillis()
                prefs[booleanPreferencesKey("is_loading")] = false
            }

            // UI ê°±ì‹ 
            WeatherWidget().update(applicationContext, glanceId)

            return Result.success()
        } catch (e: Exception) {
            // ì—ëŸ¬ ìƒíƒœ ì €ì¥
            updateAppWidgetState(applicationContext, glanceId) { prefs ->
                prefs[booleanPreferencesKey("is_loading")] = false
                prefs[stringPreferencesKey("condition")] = "ì˜¤ë¥˜"
            }
            WeatherWidget().update(applicationContext, glanceId)

            return Result.failure()
        }
    }
}
```

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** ë‚ ì”¨ ìœ„ì ¯ ì „ì²´ UI (ì˜¨ë„, ë‚ ì”¨ ìƒíƒœ, ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„, ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼)

---

---
