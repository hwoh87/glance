> [!TIP] ğŸ—£ï¸ í•µì‹¬ë‚´ìš©
ìœ„ì ¯ì´ ìƒì„±, ì—…ë°ì´íŠ¸, ì‚­ì œë˜ëŠ” ê³¼ì •ê³¼ ìˆ˜ë™/ìë™ ì—…ë°ì´íŠ¸ ë°©ë²•ì„ ì´í•´í•©ë‹ˆë‹¤.
>

## 1. ìœ„ì ¯ ìƒëª…ì£¼ê¸° ê°œìš”

Glance ìœ„ì ¯ì€ Android ì‹œìŠ¤í…œê³¼ ìƒí˜¸ì‘ìš©í•˜ë©° ë‹¤ìŒê³¼ ê°™ì€ ìƒëª…ì£¼ê¸°ë¥¼ ê°€ì§‘ë‹ˆë‹¤.

```
ğŸ“± ìœ„ì ¯ ìƒëª…ì£¼ê¸°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì‚¬ìš©ìê°€ í™ˆ í™”ë©´ì— ìœ„ì ¯ ì¶”ê°€              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   onEnabled()        â”‚ â† ì²« ë²ˆì§¸ ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ ì¶”ê°€ ì‹œ 1íšŒ
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   onUpdate()         â”‚ â† ê° ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ë§ˆë‹¤ í˜¸ì¶œ
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ provideGlance()      â”‚ â† UI ìƒì„±
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
         [ìœ„ì ¯ í‘œì‹œ]
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ì‚¬ìš©ì ì¸í„°ë™ì…˜         â”‚
    â”‚  - ë²„íŠ¼ í´ë¦­           â”‚
    â”‚  - ë¦¬ì‚¬ì´ì¦ˆ            â”‚
    â”‚  - ì„¤ì • ë³€ê²½           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   update()           â”‚ â† ìˆ˜ë™ ì—…ë°ì´íŠ¸
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ provideGlance()      â”‚ â† UI ì¬ìƒì„±
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ì‚¬ìš©ìê°€ ìœ„ì ¯ ì‚­ì œ       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   onDeleted()        â”‚ â† ê° ìœ„ì ¯ ì‚­ì œ ì‹œ
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   onDisabled()       â”‚ â† ë§ˆì§€ë§‰ ìœ„ì ¯ ì‚­ì œ ì‹œ 1íšŒ
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> [!NOTE] ğŸ’¬ NOTE
> "ìœ„ì ¯ ìƒëª…ì£¼ê¸°ë¥¼ ì´í•´í•˜ëŠ” ê²Œ ì¤‘ìš”í•©ë‹ˆë‹¤. í”Œë¡œìš°ì°¨íŠ¸ë¥¼ ë³´ë©´ ì „ì²´ íë¦„ì´ ë³´ì…ë‹ˆë‹¤.
>
> **ìµœì´ˆ ì¶”ê°€**: ì‚¬ìš©ìê°€ ìœ„ì ¯ì„ ì²˜ìŒ ì¶”ê°€í•˜ë©´ `onEnabled()` â†’ `onUpdate()` â†’ `provideGlance()` ìˆœì„œë¡œ í˜¸ì¶œë©ë‹ˆë‹¤. `onEnabled`ëŠ” ë”± í•œ ë²ˆë§Œ í˜¸ì¶œë˜ê³ , ì´ë•Œ WorkManager ê°™ì€ ì „ì—­ ë¦¬ì†ŒìŠ¤ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
>
> **ì—…ë°ì´íŠ¸**: ì´í›„ ì—…ë°ì´íŠ¸ëŠ” `update()` â†’ `provideGlance()` íë¦„ì…ë‹ˆë‹¤. ìƒíƒœë¥¼ ë³€ê²½í•˜ê³  `update()`ë¥¼ í˜¸ì¶œí•˜ë©´ `provideGlance`ê°€ ë‹¤ì‹œ ì‹¤í–‰ë˜ë©´ì„œ UIê°€ ìƒˆë¡œ ê·¸ë ¤ì§‘ë‹ˆë‹¤.
>
> **ì‚­ì œ**: ìœ„ì ¯ì„ ì‚­ì œí•˜ë©´ `onDeleted()`ê°€ í˜¸ì¶œë˜ê³ , ë§ˆì§€ë§‰ ìœ„ì ¯ì´ ì‚­ì œë˜ë©´ `onDisabled()`ê°€ í˜¸ì¶œë©ë‹ˆë‹¤. ì—¬ê¸°ì„œ WorkManagerë¥¼ ì·¨ì†Œí•˜ê±°ë‚˜ ìƒíƒœ íŒŒì¼ì„ ì •ë¦¬í•©ë‹ˆë‹¤.
>
> í•µì‹¬ì€ **onEnabled/onDisabledëŠ” ì „ì—­ ë¦¬ì†ŒìŠ¤**, **onDeletedëŠ” ì¸ìŠ¤í„´ìŠ¤ë³„ ì •ë¦¬**ë¼ëŠ” ì ì…ë‹ˆë‹¤."

---

## 2. Receiver ìƒëª…ì£¼ê¸° ì½œë°±

### 2.1 onEnabled()

**ì²« ë²ˆì§¸ ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ê°€ ì¶”ê°€ë  ë•Œ 1íšŒë§Œ í˜¸ì¶œ**ë©ë‹ˆë‹¤.

```kotlin
class MyWidgetReceiver : GlanceAppWidgetReceiver() {
    override val glanceAppWidget: GlanceAppWidget = MyWidget()

    override fun onEnabled(context: Context) {
        super.onEnabled(context)
        Log.d("WidgetLifecycle", "ì²« ìœ„ì ¯ ì¶”ê°€ë¨")

        // ì „ì—­ ì´ˆê¸°í™” ì‘ì—…
        // - WorkManager ì˜ˆì•½
        // - ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
        // - ë¦¬ì†ŒìŠ¤ ì¤€ë¹„
        schedulePeriodicUpdates(context)
    }

    private fun schedulePeriodicUpdates(context: Context) {
        val updateRequest = PeriodicWorkRequestBuilder<WidgetUpdateWorker>(
            repeatInterval = 30,
            repeatIntervalTimeUnit = TimeUnit.MINUTES
        ).build()

        WorkManager.getInstance(context).enqueueUniquePeriodicWork(
            "widget_update",
            ExistingPeriodicWorkPolicy.KEEP,
            updateRequest
        )
    }
}
```

---

### 2.2 onUpdate()

**ìœ„ì ¯ì´ ì—…ë°ì´íŠ¸ë˜ì–´ì•¼ í•  ë•Œ í˜¸ì¶œ**ë©ë‹ˆë‹¤.

**í˜¸ì¶œ ì‹œì **:
- ìœ„ì ¯ ì²˜ìŒ ì¶”ê°€ë  ë•Œ
- updatePeriodMillis ì£¼ê¸° ë„ë˜ ì‹œ (30ë¶„ ì´ìƒ, ì‹ ë¢°ë„ ë‚®ìŒ)
- ì‹œìŠ¤í…œ ì¬ë¶€íŒ… í›„
- ìˆ˜ë™ìœ¼ë¡œ `AppWidgetManager.updateAppWidget()` í˜¸ì¶œ ì‹œ

```kotlin
class MyWidgetReceiver : GlanceAppWidgetReceiver() {
    override val glanceAppWidget: GlanceAppWidget = MyWidget()

    override fun onUpdate(
        context: Context,
        appWidgetManager: AppWidgetManager,
        appWidgetIds: IntArray
    ) {
        
        Log.d("WidgetLifecycle", "onUpdate called for ${appWidgetIds.size} widgets")

        // ê° ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
        appWidgetIds.forEach { appWidgetId ->
            val glanceId = GlanceAppWidgetManager(context).getGlanceIdBy(appWidgetId)

            CoroutineScope(Dispatchers.IO).launch {
                // ì´ˆê¸° ìƒíƒœ ì„¤ì •
                updateAppWidgetState(context, glanceId) { prefs ->
                    prefs[longPreferencesKey("created_at")] = System.currentTimeMillis()
                    prefs[intPreferencesKey("count")] = 0
                }

                // UI ê°±ì‹ 
                super.onUpdate(context, appWidgetManager, appWidgetIds)
            }
        }
    }
}
```

---

### 2.3 onDeleted()

**ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ê°€ ì‚­ì œë  ë•Œ í˜¸ì¶œ**ë©ë‹ˆë‹¤.

```kotlin
override fun onDeleted(context: Context, appWidgetIds: IntArray) {
    super.onDeleted(context, appWidgetIds)
    Log.d("WidgetLifecycle", "ìœ„ì ¯ ì‚­ì œ: ${appWidgetIds.size}ê°œ")

    appWidgetIds.forEach { appWidgetId ->
        val glanceId = GlanceAppWidgetManager(context).getGlanceIdBy(appWidgetId)

        CoroutineScope(Dispatchers.IO).launch {
            // 1. ìƒíƒœ íŒŒì¼ ì‚­ì œ
            val stateFile = context.dataStoreFile("glance_$glanceId")
            if (stateFile.exists()) {
                stateFile.delete()
                Log.d("WidgetLifecycle", "ìƒíƒœ íŒŒì¼ ì‚­ì œ: $glanceId")
            }

            // 2. ë°ì´í„°ë² ì´ìŠ¤ ì •ë¦¬
            database.widgetDao().deleteByGlanceId(glanceId.toString())

            // 3. ìºì‹œ ì •ë¦¬
            clearWidgetCache(glanceId)
        }
    }
}
```

---

### 2.4 onDisabled()

**ë§ˆì§€ë§‰ ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ê°€ ì‚­ì œë  ë•Œ 1íšŒë§Œ í˜¸ì¶œ**ë©ë‹ˆë‹¤.

```kotlin
override fun onDisabled(context: Context) {
    super.onDisabled(context)
    Log.d("WidgetLifecycle", "ë§ˆì§€ë§‰ ìœ„ì ¯ ì‚­ì œë¨")

    // ì „ì—­ ì •ë¦¬ ì‘ì—…
    // - WorkManager ì·¨ì†Œ
    // - ë¦¬ì†ŒìŠ¤ í•´ì œ
    // - ì•Œë¦¼ ì·¨ì†Œ
    WorkManager.getInstance(context).cancelUniqueWork("widget_update")
}
```

---

## 3. ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±° ë°©ë²•

### 3.1 ìˆ˜ë™ ì—…ë°ì´íŠ¸: update() / updateAll()

#### 3.1.1 ë‹¨ì¼ ìœ„ì ¯ ì—…ë°ì´íŠ¸

```kotlin
class RefreshAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        val newData = fetchDataFromApi()

        // 2. ìƒíƒœ ì—…ë°ì´íŠ¸
        updateAppWidgetState(context, glanceId) { prefs ->
            prefs[stringPreferencesKey("data")] = newData
            prefs[longPreferencesKey("last_update")] = System.currentTimeMillis()
        }

        // 3. UI ê°±ì‹  (í•„ìˆ˜!)
        MyWidget().update(context, glanceId)
    }
}
```

#### 3.1.2 ëª¨ë“  ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ ì—…ë°ì´íŠ¸

```kotlin
class RefreshAllAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        val manager = GlanceAppWidgetManager(context)
        val glanceIds = manager.getGlanceIds(MyWidget::class.java)

        glanceIds.forEach { id ->
            updateAppWidgetState(context, id) { prefs ->
                prefs[longPreferencesKey("sync_time")] = System.currentTimeMillis()
            }
        }

        // ëª¨ë“  ìœ„ì ¯ í•œ ë²ˆì— ê°±ì‹ 
        MyWidget().updateAll(context)
    }
}
```

---

### 3.2 WorkManagerë¥¼ í†µí•œ ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ (ê¶Œì¥)

#### 3.2.1 Worker êµ¬í˜„

```kotlin
class WidgetUpdateWorker(
    context: Context,
    params: WorkerParameters
) : CoroutineWorker(context, params) {

    override suspend fun doWork(): Result {
        Log.d("WidgetUpdateWorker", "ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ì‹œì‘")

        return try {
            // 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            val data = fetchDataFromServer()

            // 2. ëª¨ë“  ìœ„ì ¯ ì—…ë°ì´íŠ¸
            val manager = GlanceAppWidgetManager(applicationContext)
            val glanceIds = manager.getGlanceIds(MyWidget::class.java)

            glanceIds.forEach { glanceId ->
                updateAppWidgetState(applicationContext, glanceId) { prefs ->
                    prefs[stringPreferencesKey("server_data")] = data
                    prefs[longPreferencesKey("last_sync")] = System.currentTimeMillis()
                }
            }

            // 3. UI ê°±ì‹ 
            MyWidget().updateAll(applicationContext)

            Log.d("WidgetUpdateWorker", "ì—…ë°ì´íŠ¸ ì„±ê³µ")
            Result.success()
        } catch (e: Exception) {
            Log.e("WidgetUpdateWorker", "ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", e)
            Result.retry()
        }
    }
}
```

#### 3.2.2 Worker ì˜ˆì•½ (onEnabledì—ì„œ)

```kotlin
private fun schedulePeriodicUpdates(context: Context) {
    val constraints = Constraints.Builder()
        .setRequiredNetworkType(NetworkType.CONNECTED)  // ë„¤íŠ¸ì›Œí¬ í•„ìš”
        .setRequiresBatteryNotLow(true)                // ë°°í„°ë¦¬ ì¶©ë¶„í•  ë•Œë§Œ
        .build()

    val updateRequest = PeriodicWorkRequestBuilder<WidgetUpdateWorker>(
        repeatInterval = 30,  // ìµœì†Œ 15ë¶„
        repeatIntervalTimeUnit = TimeUnit.MINUTES
    )
        .setConstraints(constraints)
        .setBackoffCriteria(
            BackoffPolicy.EXPONENTIAL,
            WorkRequest.MIN_BACKOFF_MILLIS,
            TimeUnit.MILLISECONDS
        )
        .build()

    WorkManager.getInstance(context).enqueueUniquePeriodicWork(
        "widget_periodic_update",
        ExistingPeriodicWorkPolicy.KEEP,  // ê¸°ì¡´ ì‘ì—… ìœ ì§€
        updateRequest
    )
}
```

---

## 4. ì‹œìŠ¤í…œ ì´ë²¤íŠ¸ì— ë”°ë¥¸ ì—…ë°ì´íŠ¸

### 4.1 í™”ë©´ í¬ê¸° ë³€ê²½ (ë¦¬ì‚¬ì´ì¦ˆ)

```kotlin
class Step1WidgetReceiver : GlanceAppWidgetReceiver() { 
....

override fun onAppWidgetOptionsChanged(
    context: Context,
    appWidgetManager: AppWidgetManager,
    appWidgetId: Int,
    newOptions: Bundle
) {
    super.onAppWidgetOptionsChanged(context, appWidgetManager, appWidgetId, newOptions)

    val minWidth = newOptions.getInt(AppWidgetManager.OPTION_APPWIDGET_MIN_WIDTH)
Â  Â  val minHeight = newOptions.getInt(AppWidgetManager.OPTION_APPWIDGET_MIN_HEIGHT)
Â  Â  Log.d("WidgetResize", "Widget resized: ${minWidth}x${minHeight}")
Â  Â  
Â  Â  // âŒ ìˆ˜ë™ update()ëŠ” ë¶ˆí•„ìš” (Glanceê°€ ìë™ìœ¼ë¡œ provideGlance í˜¸ì¶œ)
Â  Â  // âœ… í•˜ì§€ë§Œ íŠ¹ì • ì¡°ê±´ì—ì„œëŠ” ì»¤ìŠ¤í…€ ì‘ì—… ìˆ˜í–‰ ê°€ëŠ¥
Â  Â  if (minWidth > 300 && minHeight > 200) {
Â  Â  Â  Â  // ì˜ˆ: í° ì‚¬ì´ì¦ˆì—ì„œëŠ” ì¶”ê°€ ë°ì´í„° ìš”ì²­
Â  Â  Â  Â  WorkManager.getInstance(context)
Â  Â  Â  Â  Â  Â  .enqueueUniqueWork("widget_prefetch", ExistingWorkPolicy.REPLACE, fetchWork)
Â  Â  }
}
}
```
> [!NOTE] ğŸ’¬ NOTE
> > ì „í†µ(RemoteViews)ì—ì„œëŠ” onAppWidgetOptionsChanged()ë¥¼ ì˜¤ë²„ë¼ì´ë“œí•´ **ìˆ˜ë™ìœ¼ë¡œ** ë ˆì´ì•„ì›ƒì„ ë°”ê¿¨ì§€ë§Œ, **Glance**ì—ì„œëŠ” í¬ê¸° ë³€ê²½ ì‹œ provideGlance()ê°€ **ìë™ ì¬í˜¸ì¶œ**ë˜ê³ , ìœ„ì ¯ í´ë˜ìŠ¤ì˜ sizeModeì™€ LocalSize.currentë¥¼ ê¸°ì¤€ìœ¼ë¡œ **ë™ì  ë ˆì´ì•„ì›ƒì„ ì„ íƒ**í•˜ë©´ ë©ë‹ˆë‹¤.

---

### 4.2 ì¬ë¶€íŒ… í›„ ë³µì›

```xml
<!-- AndroidManifest.xml -->
<receiver
    android:name=".BootCompletedReceiver"
    android:exported="true">
    <intent-filter>
        <action android:name="android.intent.action.BOOT_COMPLETED" />
    </intent-filter>
</receiver>
```

```kotlin
class BootCompletedReceiver : BroadcastReceiver() {
    override fun onReceive(context: Context, intent: Intent) {
        if (intent.action == Intent.ACTION_BOOT_COMPLETED) {
            // WorkManager ì¬ë“±ë¡
            schedulePeriodicUpdates(context)

            // ëª¨ë“  ìœ„ì ¯ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            CoroutineScope(Dispatchers.IO).launch {
                MyWidget().updateAll(context)
            }
        }
    }
}
```

---
