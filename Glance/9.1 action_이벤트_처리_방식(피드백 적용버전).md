# 9. Action(이벤트) 처리 방식⭐⭐

---

## 9.1 개요
Glance의 **Action 시스템**은 RemoteViews 시절의 `PendingIntent` 기반 이벤트 처리를 **Compose DSL 스타일**로 추상화한 것입니다.

```kotlin
Button(
    text = "새로고침",
    onClick = actionRunCallback<RefreshDataAction>()
)
```

이 코드는 전통적인 `setOnClickPendingIntent()` + `BroadcastReceiver` 구조를 **간단한 DSL 한 줄**로 표현합니다.

Glance는 내부적으로 적절한 `PendingIntent`와 `FLAG_IMMUTABLE` 등을 자동으로 설정하며, 안전한 실행 컨텍스트를 제공합니다.

---

## 9.2 주요 액션 타입 비교

| Action 유형 | 설명 | 사용 위치 | 예시 |
|--------------|------|------------|------|
| **`actionRunCallback<T>()`** | Glance 내부 콜백(ActionCallback) 실행 | 위젯 내부 | 데이터 갱신, 상태 업데이트 |
| **`actionStartActivity(intent)`** | Activity 실행 | 외부 앱 / 설정 이동 | 앱 열기, 설정 화면 진입 |
| **`actionSendBroadcast(intent)`** | Broadcast 송신 | 앱 외부 또는 내부 이벤트 알림 | 백그라운드 브로드캐스트 |
| **`actionStartService(intent)`** | 서비스 시작 (Deprecated) | 백그라운드 서비스 | ForegroundService는 직접 구현 필요 |
| **`action()`** | 완전 커스텀 액션 | 모든 상황 | 전화, 브라우저, 이메일 등 |

> [!TIP] Glance는 내부적으로 안전한 `PendingIntent` 플래그(`FLAG_IMMUTABLE` 등)를 자동으로 설정합니다. `action()` 커스텀만 예외적으로 직접 플래그 지정이 필요합니다.

---

## 9.3 `actionRunCallback` 사용 예시

Glance의 핵심 이벤트 처리 패턴은 `ActionCallback`을 통한 콜백 실행입니다.

```kotlin
class RefreshDataAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        updateAppWidgetState(context, glanceId) { prefs ->
            prefs[booleanPreferencesKey("is_loading")] = true
        }
        MyWidget().update(context, glanceId)

        // 장시간 작업은 Worker로 위임
        WorkManager.getInstance(context).enqueue(
            OneTimeWorkRequestBuilder<DataFetchWorker>().build()
        )
    }
}
```

> [!WARNING] `onAction` 내부에서는 직접 네트워크 호출을 하지 말고, `WorkManager`를 활용하세요. Glance의 Action은 UI 프로세스에서 실행되므로 장기 작업에 부적합합니다.

---

## 9.4 `actionSendBroadcast` 예시

Broadcast를 이용해 앱 외부로 이벤트를 보낼 수 있습니다.

```kotlin
Button(
    text = "브로드캐스트 보내기",
    onClick = actionSendBroadcast(Intent(context, MyReceiver::class.java))
)
```

```kotlin
class MyReceiver : BroadcastReceiver() {
    override fun onReceive(context: Context, intent: Intent) {
        CoroutineScope(Dispatchers.IO).launch {
            // 수신 후 처리 (데이터 저장 등)
            updateAppWidgetState(context, glanceId) { prefs ->
                prefs[stringPreferencesKey("status")] = "done"
            }
            MyWidget().update(context, glanceId)
        }
    }
}
```

> [!NOTE] `GlobalScope.launch` 대신 `CoroutineScope(Dispatchers.IO).launch`를 사용하는 것이 좋습니다. Receiver 수명이 짧기 때문에 스코프를 별도로 관리하지 않으면 누수 위험이 있습니다. 장기 작업이라면 `WorkManager`를 사용하는 것이 더 안전합니다.

---

## 9.5 `actionStartActivity` 예시

```kotlin
Button(
    text = "앱 열기",
    onClick = actionStartActivity(Intent(context, MainActivity::class.java))
)
```

> 런처에서 앱을 바로 열거나 설정 화면으로 이동할 때 사용합니다. Glance가 내부적으로 `FLAG_ACTIVITY_NEW_TASK`와 `FLAG_IMMUTABLE` 등을 자동으로 설정합니다.

---

## 9.6 Deprecated: `actionStartService`

`actionStartService`는 Android 14(API 34)부터 점진적으로 제한됩니다. 대신 **`WorkManager`**나 **ForegroundService + Broadcast** 조합을 사용하는 것이 권장됩니다.

> [!TIP] `actionStartForegroundService` 같은 별도 API는 없습니다. 대신 일반 `action()`이나 `BroadcastReceiver`를 통해 직접 `startForegroundService()`를 호출할 수 있습니다.

---

## 9.7 커스텀 `action()` 예시

```kotlin
Button(
    text = "전화 걸기",
    onClick = actionStartActivity(Intent(Intent.ACTION_DIAL, Uri.parse("tel:010-1234-5678")))
)

Button(
    text = "브라우저 열기",
    onClick = actionStartActivity(Intent(Intent.ACTION_VIEW, Uri.parse("https://developer.android.com")))
)
```

> [!TIP] 발표 시에는 대표적인 몇 가지 액션만 아이콘과 함께 소개하고, “이 외에도 다양한 액션이 가능하다” 정도로 언급하는 것이 좋습니다.

---

## 9.8 발표용 정리 제안

| 핵심 포인트 | 발표 강조 포인트 |
|--------------|------------------|
| **update() 호출 필수** | “상태 바꿨으면 update() 호출!” – 강조 슬라이드로 별도 처리 |
| **ActionCallback vs Activity 차이** | 내부(Glance) vs 외부(App) 실행 흐름을 비교 도식으로 설명 |
| **Worker와 연계** | “무거운 작업은 Worker로 넘기자” – 흐름도 예시로 명시 |

> [!NOTE] Q&A 대비 포인트: “Glance가 PendingIntent 플래그를 자동으로 설정하나요?” → 네, `actionX` 계열 API는 기본적으로 `FLAG_IMMUTABLE` 등을 내부에서 자동 지정합니다. 다만 `action()` 커스텀에서는 직접 지정해야 합니다.

---

## 9.9 핵심 요약
- `GlobalScope.launch` 대신 `CoroutineScope(Dispatchers.IO)` 또는 `WorkManager`를 사용.
- `GlanceId`를 문자열로 직렬화하기보다 `ActionParameters`나 상태를 통해 전달하는 구조를 권장.
- `actionStartService`는 Deprecated → `WorkManager` 또는 `BroadcastReceiver + ForegroundService`로 대체.
- 슬라이드에서는 **액션별 대표 사례 3~4개만** 시각적으로 강조.
- `update()` 호출 누락 주의 문구를 별도 강조.
- Q&A 대비: Glance는 내부적으로 안전한 플래그 설정을 자동 처리함.

---

> ✅ **발표용 결론 문장 예시**
>
> “Glance의 액션 시스템은 Compose DSL로 PendingIntent를 대체한 개념입니다.
> `actionRunCallback`으로 내부 로직을, `actionStartActivity`로 외부 앱을 제어하고, `WorkManager`를 통해 백그라운드 작업을 안정적으로 처리합니다.”

