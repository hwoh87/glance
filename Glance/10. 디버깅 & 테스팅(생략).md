> [!TIP] ğŸ—£ï¸ í•µì‹¬ë‚´ìš©
ìœ„ì ¯ ê°œë°œ ì¤‘ ë°œìƒí•˜ëŠ” ë¬¸ì œ í•´ê²° ë°©ë²•ê³¼ Previewë¥¼ í™œìš©í•œ íš¨ìœ¨ì ì¸ ê°œë°œ ë°©ë²•ì„ ì†Œê°œí•©ë‹ˆë‹¤.
>

## 1. ë””ë²„ê¹… ê°œìš”

Glance ìœ„ì ¯ì€ ë³„ë„ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰ë˜ê³  RemoteViewsë¡œ ë³€í™˜ë˜ê¸° ë•Œë¬¸ì— ì¼ë°˜ ì•±ë³´ë‹¤ ë””ë²„ê¹…ì´ ê¹Œë‹¤ë¡­ìŠµë‹ˆë‹¤. íš¨ìœ¨ì ì¸ ë””ë²„ê¹… ì „ëµì´ í•„ìš”í•©ë‹ˆë‹¤.

```
ğŸ› ë””ë²„ê¹… ë‚œì´ë„
ì•± Activity: â˜…â˜†â˜†â˜†â˜†
Compose UI: â˜…â˜…â˜†â˜†â˜†
Glance ìœ„ì ¯: â˜…â˜…â˜…â˜…â˜† â† ë³„ë„ í”„ë¡œì„¸ìŠ¤, RemoteViews ë³€í™˜
```

---

## 2. ë¡œê·¸ ê¸°ë°˜ ë””ë²„ê¹…

### 2.1 ê¸°ë³¸ ë¡œê¹…
```kotlin
class MyWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        Log.d("MyWidget", "provideGlance called for $id")

        provideContent {
            val prefs = currentState<Preferences>()
            val count = prefs[intPreferencesKey("count")] ?: 0

            Log.d("MyWidget", "Rendering with count: $count")

            Column {
                Text("Count: $count")
            }
        }
    }
}
```

### 2.2 ìƒíƒœ ë¡œê¹… ìœ í‹¸ë¦¬í‹°
```kotlin
suspend fun logWidgetState(context: Context, glanceId: GlanceId, tag: String = "WidgetState") {
    val file = context.dataStoreFile("glance_${glanceId}")
    val dataStore = DataStoreFactory.create(PreferencesSerializer) { file }
    val prefs = dataStore.data.first()

    Log.d(tag, "=== Widget State for $glanceId ===")
    prefs.asMap().forEach { (key, value) ->
        Log.d(tag, "  ${key.name}: $value")
    }
    Log.d(tag, "================================")
}

// ì‚¬ìš© ì˜ˆì‹œ
class DebugAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        logWidgetState(context, glanceId)
    }
}
```

### 2.3 ë Œë”ë§ íŒŒì´í”„ë¼ì¸ ì¶”ì 
```kotlin
class TrackedWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        Log.d("TrackedWidget", "1. provideGlance START")

        val startTime = System.currentTimeMillis()

        provideContent {
            Log.d("TrackedWidget", "2. provideContent START")

            val prefs = currentState<Preferences>()
            Log.d("TrackedWidget", "3. State loaded: ${prefs.asMap().size} keys")

            val size = LocalSize.current
            Log.d("TrackedWidget", "4. Size: ${size.width} x ${size.height}")

            Column {
                Text("Debug Widget")
            }

            Log.d("TrackedWidget", "5. provideContent END")
        }

        val elapsed = System.currentTimeMillis() - startTime
        Log.d("TrackedWidget", "6. provideGlance END ($elapsed ms)")
    }
}
```

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** Logcatì—ì„œ ìœ„ì ¯ ë¡œê·¸ í•„í„°ë§í•œ í™”ë©´

---

## 3. Preview í™œìš© (ì„ íƒì )

Glance ìœ„ì ¯ì€ Previewë¥¼ ì œí•œì ìœ¼ë¡œ ì§€ì›í•©ë‹ˆë‹¤. ì‹¤ê¸°ê¸°ì—ì„œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤.

---

## 4. ì¼ë°˜ì ì¸ ë¬¸ì œì™€ í•´ê²°ì±…

### 4.1 ìœ„ì ¯ì´ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ

**ë¬¸ì œ**
```kotlin
// âŒ update() í˜¸ì¶œ ëˆ„ë½
class BadAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        updateAppWidgetState(context, glanceId) { prefs ->
            prefs[intPreferencesKey("count")] = 10
        }
        // update() í˜¸ì¶œ ì•ˆ í•¨!
    }
}
```

**í•´ê²°ì±…**
```kotlin
// âœ… update() í˜¸ì¶œ í•„ìˆ˜
class GoodAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        updateAppWidgetState(context, glanceId) { prefs ->
            prefs[intPreferencesKey("count")] = 10
        }
        MyWidget().update(context, glanceId) // í•„ìˆ˜!
    }
}
```

---

### 4.2 ìœ„ì ¯ì´ ëª©ë¡ì— ë‚˜íƒ€ë‚˜ì§€ ì•ŠìŒ

**ì²´í¬ë¦¬ìŠ¤íŠ¸**
- [ ] AndroidManifest.xmlì— receiver ë“±ë¡ë¨?
- [ ] ProviderInfo XML íŒŒì¼ ì¡´ì¬í•¨?
- [ ] initialLayout ë¦¬ì†ŒìŠ¤ ì¡´ì¬í•¨?
- [ ] minWidth, minHeight ì„¤ì •ë¨?

```xml
<!-- AndroidManifest.xml -->
<receiver
    android:name=".MyWidgetReceiver"
    android:exported="true">
    <intent-filter>
        <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
    </intent-filter>
    <meta-data
        android:name="android.appwidget.provider"
        android:resource="@xml/my_widget_info" />
</receiver>

<!-- res/xml/my_widget_info.xml -->
<appwidget-provider
    android:initialLayout="@layout/placeholder"
    android:minWidth="180dp"
    android:minHeight="110dp"
    android:previewImage="@drawable/widget_preview"
    android:resizeMode="horizontal|vertical"
    android:widgetCategory="home_screen" />

<!-- res/layout/placeholder.xml -->
<TextView
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:text="Loading..."
    android:gravity="center" />
```

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** ìœ„ì ¯ ì„ íƒ í™”ë©´ì—ì„œ ìœ„ì ¯ì´ ì •ìƒì ìœ¼ë¡œ ë³´ì´ëŠ” ëª¨ìŠµ

---

### 4.3 Crash: "RemoteViews doesn't support..."

**ë¬¸ì œ**: Glanceê°€ ì§€ì›í•˜ì§€ ì•ŠëŠ” Compose ê¸°ëŠ¥ ì‚¬ìš©

```kotlin
// âŒ ì§€ì›í•˜ì§€ ì•ŠìŒ
provideContent {
    var count by remember { mutableStateOf(0) } // remember ë¶ˆê°€
    LaunchedEffect(Unit) { /* ... */ } // LaunchedEffect ë¶ˆê°€
    Image(painter = /* Coil */, contentDescription = null) // Coil ì§ì ‘ ì‚¬ìš© ë¶ˆê°€
}
```

**í•´ê²°ì±…**: Glance ì „ìš© API ì‚¬ìš©
```kotlin
// âœ… ìƒíƒœëŠ” currentState() + updateAppWidgetState()
provideContent {
    val prefs = currentState<Preferences>()
    val count = prefs[intPreferencesKey("count")] ?: 0

    // ì´ë¯¸ì§€ëŠ” ë¦¬ì†ŒìŠ¤ ë˜ëŠ” URI
    Image(
        provider = ImageProvider(R.drawable.icon),
        contentDescription = "Icon"
    )
}
```

---

### 4.4 ì—¬ëŸ¬ ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ê°€ ê°™ì€ ìƒíƒœ ê³µìœ 

**ë¬¸ì œ**: GlanceIdë¥¼ ë¬´ì‹œí•˜ê³  ì „ì—­ ìƒíƒœ ì‚¬ìš©

```kotlin
// âŒ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ê°€ ê°™ì€ ê°’ì„ ë³´ì—¬ì¤Œ
class BadWidget : GlanceAppWidget() {
    companion object {
        var globalCount = 0 // ê³µìœ  ë³€ìˆ˜
    }

    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            Text("Count: $globalCount")
        }
    }
}
```

**í•´ê²°ì±…**: GlanceIdë³„ ìƒíƒœ ê´€ë¦¬
```kotlin
// âœ… ê° ì¸ìŠ¤í„´ìŠ¤ê°€ ë…ë¦½ì ì¸ ìƒíƒœ
class GoodWidget : GlanceAppWidget() {
    override val stateDefinition = PreferencesGlanceStateDefinition

    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            val prefs = currentState<Preferences>()
            val count = prefs[intPreferencesKey("count")] ?: 0
            Text("Count: $count")
        }
    }
}
```

**[ë¹„ë””ì˜¤ ì¶”ì²œ]** ê°™ì€ ìœ„ì ¯ 3ê°œë¥¼ ì¶”ê°€í•˜ê³  ê°ê° ë…ë¦½ì ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ëª¨ìŠµ

---

## 5. í…ŒìŠ¤íŠ¸ ì „ëµ

### 5.1 Unit Test: StateDefinition
```kotlin
@Test
fun `ìœ„ì ¯ ìƒíƒœ ì €ì¥ ë° ë¡œë“œ í…ŒìŠ¤íŠ¸`() = runTest {
    val context = ApplicationProvider.getApplicationContext<Context>()
    val testGlanceId = AppWidgetId(12345)

    // ìƒíƒœ ì €ì¥
    updateAppWidgetState(context, testGlanceId) { prefs ->
        prefs[intPreferencesKey("count")] = 42
        prefs[stringPreferencesKey("name")] = "Test"
    }

    // ìƒíƒœ ë¡œë“œ
    val file = context.dataStoreFile("glance_$testGlanceId")
    val dataStore = DataStoreFactory.create(PreferencesSerializer) { file }
    val prefs = dataStore.data.first()

    assertEquals(42, prefs[intPreferencesKey("count")])
    assertEquals("Test", prefs[stringPreferencesKey("name")])
}
```

### 5.2 Unit Test: ActionCallback
```kotlin
@Test
fun `IncrementAction í…ŒìŠ¤íŠ¸`() = runTest {
    val context = ApplicationProvider.getApplicationContext<Context>()
    val testGlanceId = AppWidgetId(12345)

    // ì´ˆê¸° ìƒíƒœ
    updateAppWidgetState(context, testGlanceId) { prefs ->
        prefs[intPreferencesKey("count")] = 0
    }

    // Action ì‹¤í–‰
    val action = IncrementAction()
    action.onAction(context, testGlanceId, ActionParameters.Empty)

    // ê²°ê³¼ í™•ì¸
    val file = context.dataStoreFile("glance_$testGlanceId")
    val dataStore = DataStoreFactory.create(PreferencesSerializer) { file }
    val prefs = dataStore.data.first()

    assertEquals(1, prefs[intPreferencesKey("count")])
}
```

### 5.3 Integration Test
```kotlin
@RunWith(AndroidJUnit4::class)
class WidgetIntegrationTest {
    @get:Rule
    val composeTestRule = createComposeRule()

    @Test
    fun `ìœ„ì ¯ ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸`() {
        // 1. ìœ„ì ¯ ì¶”ê°€
        val appWidgetId = addWidget()

        // 2. ìƒíƒœ í™•ì¸
        val glanceId = GlanceAppWidgetManager(context)
            .getGlanceIdBy(appWidgetId)

        val prefs = getWidgetState(glanceId)
        assertEquals(0, prefs[intPreferencesKey("count")])

        // 3. Action ì‹¤í–‰
        performClick(glanceId, IncrementAction::class.java)

        // 4. ì—…ë°ì´íŠ¸ëœ ìƒíƒœ í™•ì¸
        val updatedPrefs = getWidgetState(glanceId)
        assertEquals(1, updatedPrefs[intPreferencesKey("count")])
    }
}
```

---

## 6. ê°œë°œ ì›Œí¬í”Œë¡œìš° ê¶Œì¥ì‚¬í•­

### 6.1 ë¹ ë¥¸ ë°˜ë³µ ê°œë°œ
```
1. Previewë¡œ UI ì´ˆì•ˆ ì‘ì„± (ë¹ ë¦„)
2. ì—ë®¬ë ˆì´í„°/ì‹¤ê¸°ê¸°ì—ì„œ ì‹¤ì œ ìœ„ì ¯ í…ŒìŠ¤íŠ¸
3. Logcatìœ¼ë¡œ ë™ì‘ í™•ì¸
4. í•„ìš”ì‹œ Unit Test ì‘ì„±
```

### 6.2 ë””ë²„ê·¸ ë¹Œë“œ ì „ìš© ê¸°ëŠ¥
```kotlin
class DebugWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            Column {
                if (BuildConfig.DEBUG) {
                    Text("GlanceId: $id", style = TextStyle(fontSize = 10.sp))
                    Text("Size: ${LocalSize.current}", style = TextStyle(fontSize = 10.sp))
                    Button("Log State", onClick = actionRunCallback<LogStateAction>())
                }

                // ì‹¤ì œ ìœ„ì ¯ UI
                MainWidgetContent()
            }
        }
    }
}
```

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** ë””ë²„ê·¸ ì •ë³´ê°€ í‘œì‹œëœ ìœ„ì ¯ (GlanceId, Size ë“±)

---

---
