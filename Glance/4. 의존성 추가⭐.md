> [!TIP] 🗣️ 핵심내용
Glance를 프로젝트에 통합하기 위한 Gradle 설정과 필수 라이브러리를 알아봅니다.
>

## 1. Gradle 의존성 추가

### 1.1 모듈 레벨 build.gradle.kts

```kotlin
android {
    compileSdk = 34

    defaultConfig {
        minSdk = 23  // ⭐ Glance 최소 요구사항
        targetSdk = 34
    }

    buildFeatures {
        compose = true  // ⭐ Glance 필수
    }

    composeOptions {
        kotlinCompilerExtensionVersion = "1.5.4"  // ⭐ Compose Compiler 버전
    }
}

dependencies {
    // 필수: Glance 위젯 라이브러리
    implementation("androidx.glance:glance-appwidget:1.1.1")

    // 추천: Material3 테마 지원
    implementation("androidx.glance:glance-material3:1.1.0")

    // 필수: 상태 관리용 DataStore
    implementation("androidx.datastore:datastore-preferences:1.1.1")

    // 추천: 백그라운드 작업용 WorkManager
    implementation("androidx.work:work-runtime-ktx:2.9.0")
}
```

> [!NOTE]
> **핵심 설정**:
> - **minSdk 23**: Glance의 최소 지원 버전
> - **compose = true**: Glance는 Compose DSL 기반으로 작동
> - **composeOptions**: Kotlin 버전과 호환되는 Compose Compiler 버전 필요

---

## 2. 의존성 설명

### 2.1 핵심 의존성

| 라이브러리                   | 버전    | 필수 여부 | 설명                 |
| ----------------------- | ----- | ----- | ------------------ |
| `glance-appwidget`      | 1.1.1 | ✅ 필수  | Glance 위젯 핵심 라이브러리 |
| `datastore-preferences` | 1.1.1 | ✅ 필수  | 위젯 상태 저장용          |

### 2.2 추천 의존성

| 라이브러리              | 버전     | 용도                 |
| ------------------ | ------ | ------------------ |
| `glance-material3` | 1.1.1  | Material3 디자인 컴포넌트 |
| `work-runtime-ktx` | 2.10.1 | 주기적 업데이트, 백그라운드 작업 |

### 2.3 Proto DataStore 사용 시 추가 의존성
복잡한 데이터 구조를 다룰 때 Proto DataStore를 사용하려면 추가 의존성이 필요합니다.

| 라이브러리               | 버전      | 용도                   |
| ------------------- | ------- | -------------------- |
| `datastore` (core)  | 1.1.0   | Proto DataStore 코어   |
| `protobuf-javalite` | 3.21.12 | Protocol Buffers 런타임 |
| Protobuf 플러그인       | 0.9.4   | .proto 파일 컴파일        |

> [!NOTE]
> Proto DataStore는 복잡한 데이터 구조(중첩 객체, 리스트 등)를 저장할 때 사용합니다. 간단한 key-value 저장만 필요하다면 `datastore-preferences`만 사용하면 됩니다.

** 추가의존성에 대한 자세한 내용은 → [[4.1 Proto DataStore 사용 시 추가 설정]]** 참고

---

## 3. 버전 카탈로그 사용 (권장)

최신 프로젝트는 `libs.versions.toml`을 사용합니다.

### 3.1 gradle/libs.versions.toml

```toml
[versions]
glance = "1.1.1"
glanceMaterial = "1.1.0"
datastore = "1.1.1"
work = "2.9.0"
compose = "1.5.4"

[libraries]
glance-appwidget = { module = "androidx.glance:glance-appwidget", version.ref = "glance" }
glance-material3 = { module = "androidx.glance:glance-material3", version.ref = "glanceMaterial" }
datastore-preferences = { module = "androidx.datastore:datastore-preferences", version.ref = "datastore" }
work-runtime = { module = "androidx.work:work-runtime-ktx", version.ref = "work" }

[bundles]
glance = ["glance-appwidget", "glance-material3", "datastore-preferences"]
```

### 3.2 build.gradle.kts에서 사용

```kotlin
dependencies {
    // 번들로 한 번에 추가
    implementation(libs.bundles.glance)
    implementation(libs.work.runtime)

    // 또는 개별 추가
    implementation(libs.glance.appwidget)
    implementation(libs.glance.material3)
}
```

---

## 4. AndroidManifest.xml 위젯 등록

```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <application>
        <!-- ⭐ Glance 위젯 Receiver 등록 (필수) -->
        <receiver
            android:name=".widget.MyWidgetReceiver"
            android:exported="true">
            <intent-filter>
                <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
            </intent-filter>
            <meta-data
                android:name="android.appwidget.provider"
                android:resource="@xml/my_widget_info" />
        </receiver>
    </application>
</manifest>
```

> [!NOTE]
> **핵심 요소**:
> - **android:exported="true"**: 시스템(런처)에서 접근 가능하도록 필수
> - **APPWIDGET_UPDATE**: 위젯 업데이트 브로드캐스트 수신
> - **meta-data**: 위젯 설정 정보 XML 연결 (크기, 업데이트 주기 등)

---

## 5. ProGuard / R8 규칙

release 빌드 시 난독화로 인한 문제를 방지합니다.

> [!NOTE]
> "Release 빌드할 때 **ProGuard/R8 규칙**이 중요합니다. 안 넣으면 위젯이 런타임에 크래시 날 수 있어요.
>
> Glance는 **리플렉션**으로 클래스를 동적으로 생성합니다. ActionCallback, GlanceAppWidget, GlanceAppWidgetReceiver 같은 클래스들을 시스템이 런타임에 찾아서 인스턴스를 만들어요.
>
> 근데 ProGuard가 난독화하면 클래스 이름이 `a`, `b`, `c` 같은 걸로 바뀌고, 안 쓰는 것처럼 보이는 생성자는 아예 제거됩니다. 그러면 Glance가 클래스를 못 찾거나 생성자를 못 호출해서 크래시가 나죠.
>
> `-keep class` 규칙은 '이 클래스는 난독화하지 마' 라는 뜻이고, `public <init>()` 규칙은 '기본 생성자 제거하지 마'라는 뜻입니다. WorkManager의 Worker 클래스도 마찬가지 이유로 keep이 필요합니다."

### 5.1 proguard-rules.pro

```proguard
# Glance
-keep class androidx.glance.** { *; }
-dontwarn androidx.glance.**

# DataStore
-keep class androidx.datastore.** { *; }
-dontwarn androidx.datastore.**

# Protobuf (Proto DataStore 사용 시)
-keep class * extends com.google.protobuf.GeneratedMessageLite { *; }

# WorkManager
-keep class * extends androidx.work.Worker
-keep class * extends androidx.work.CoroutineWorker

# ActionCallback
-keep class * implements androidx.glance.action.ActionCallback {
    public <init>();
}

# GlanceAppWidget
-keep class * extends androidx.glance.appwidget.GlanceAppWidget {
    public <init>();
}

# GlanceAppWidgetReceiver
-keep class * extends androidx.glance.appwidget.GlanceAppWidgetReceiver {
    public <init>();
}
```

---

## 6. 의존성 트리 확인

Glance가 내부적으로 어떤 라이브러리를 사용하는지 확인할 수 있습니다.

```bash
./gradlew :app:dependencies
```

**출력 예시**:
```
+--- androidx.glance:glance-appwidget:1.1.1
|    +--- androidx.glance:glance:1.1.1
|    |    +--- androidx.compose.runtime:runtime:1.5.4
|    |    +--- androidx.compose.ui:ui:1.5.4
|    |    \--- org.jetbrains.kotlinx:kotlinx-coroutines-core:1.7.3
|    +--- androidx.datastore:datastore-preferences:1.0.0
|    \--- androidx.work:work-runtime-ktx:2.8.0
+--- androidx.glance:glance-material3:1.1.0
|    +--- androidx.compose.material3:material3:1.1.2
|    \--- androidx.glance:glance-appwidget:1.1.1
...
```

> [!NOTE]
> 의존성 트리를 통해 Glance가 내부적으로 Compose Runtime, UI, Coroutines 등을 사용함을 확인할 수 있습니다. 버전 충돌이 발생하면 이 명령으로 원인을 파악할 수 있습니다.

---

## 7. 버전 호환성

| 항목         | 최소 버전            | 권장 버전     |
| ---------- | ---------------- | --------- |
| minSdk     | 23 (Android 6.0) | 23+       |
| compileSdk | 33+              | 34        |
| Kotlin     | 1.8.0+           | 1.9.20+   |
| Compose    | 1.5.0+           | 1.5.4+    |

> [!IMPORTANT]
> **minSdk 23**은 Glance의 절대 최소 요구사항입니다. Android 6.0 미만에서는 Glance 위젯이 동작하지 않습니다.

---
