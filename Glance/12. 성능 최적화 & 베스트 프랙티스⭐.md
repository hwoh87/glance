> [!TIP] ğŸ—£ï¸ í•µì‹¬ë‚´ìš©
ë°°í„°ë¦¬ íš¨ìœ¨ì ì¸ ìœ„ì ¯ ì„¤ê³„ì™€ ì—…ë°ì´íŠ¸ ë¹ˆë„ ê´€ë¦¬, ë©”ëª¨ë¦¬ ìµœì í™” íŒì„ ê³µìœ í•©ë‹ˆë‹¤.
>

## 1. ì„±ëŠ¥ ìµœì í™” ê°œìš”

Glance ìœ„ì ¯ì€ í™ˆ í™”ë©´ì— ìƒì£¼í•˜ë©° ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ë¥¼ ì§€ì†ì ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. ë°°í„°ë¦¬, ë©”ëª¨ë¦¬, CPU íš¨ìœ¨ì„ ê³ ë ¤í•œ ì„¤ê³„ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤.

```
âš¡ ìœ„ì ¯ ì„±ëŠ¥ 3ëŒ€ ì›ì¹™
1. ì—…ë°ì´íŠ¸ ìµœì†Œí™” (ë°°í„°ë¦¬)
2. UI ë‹¨ìˆœí™” (ë Œë”ë§ ë¹„ìš©)
3. ë¬´ê±°ìš´ ì‘ì—… ë¶„ë¦¬ (Worker/Repository)
```

---

## 2. ì—…ë°ì´íŠ¸ ë¹ˆë„ ìµœì í™”

### 2.1 ë¶ˆí•„ìš”í•œ ì—…ë°ì´íŠ¸ ë°©ì§€

**âŒ ë‚˜ìœ ì˜ˆ: ê³¼ë„í•œ ì—…ë°ì´íŠ¸**
```kotlin
// 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸ (ë°°í„°ë¦¬ ì†Œëª¨ ì‹¬ê°!)
class BadWidget : GlanceAppWidget() {
    init {
        CoroutineScope(Dispatchers.Main).launch {
            while (true) {
                delay(1000)
                updateAll(context) // ë§¤ì´ˆ ì‹¤í–‰!
            }
        }
    }
}
```

**âœ… ì¢‹ì€ ì˜ˆ: í•„ìš”í•  ë•Œë§Œ ì—…ë°ì´íŠ¸**
```kotlin
class GoodWidget : GlanceAppWidget() {
    // ì‚¬ìš©ì íŠ¸ë¦¬ê±°ë¡œë§Œ ì—…ë°ì´íŠ¸
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            Column {
                Text("Last update: ${getCurrentTime()}")
                Button(
                    text = "ìƒˆë¡œê³ ì¹¨",
                    onClick = actionRunCallback<RefreshAction>()
                )
            }
        }
    }
}

class RefreshAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // ë°ì´í„° ê°±ì‹ 
        fetchNewData()

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        updateAppWidgetState(context, glanceId) { prefs ->
            prefs[longPreferencesKey("last_update")] = System.currentTimeMillis()
        }

        MyWidget().update(context, glanceId)
    }
}
```

---

### 2.2 ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ì „ëµ

**ë°©ë²• 1: PeriodicWorkRequest (ê¶Œì¥)**
```kotlin
// 15ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸ (ìµœì†Œ ì£¼ê¸°)
class WidgetUpdateWorker(context: Context, params: WorkerParameters)
    : CoroutineWorker(context, params) {

    override suspend fun doWork(): Result {
        return try {
            // ë°ì´í„° ê°±ì‹ 
            val data = fetchData()

            // ìœ„ì ¯ ìƒíƒœ ì—…ë°ì´íŠ¸
            val manager = GlanceAppWidgetManager(applicationContext)
            val glanceIds = manager.getGlanceIds(MyWidget::class.java)

            glanceIds.forEach { glanceId ->
                updateAppWidgetState(applicationContext, glanceId) { prefs ->
                    prefs[stringPreferencesKey("data")] = data
                }
            }

            // UI ê°±ì‹ 
            MyWidget().updateAll(applicationContext)

            Result.success()
        } catch (e: Exception) {
            Log.e("WidgetUpdateWorker", "Update failed", e)
            Result.retry()
        }
    }
}

// Worker ë“±ë¡
fun scheduleWidgetUpdates(context: Context) {
    val updateRequest = PeriodicWorkRequestBuilder<WidgetUpdateWorker>(
        repeatInterval = 15, // ìµœì†Œ 15ë¶„
        repeatIntervalTimeUnit = TimeUnit.MINUTES
    ).setConstraints(
        Constraints.Builder()
            .setRequiredNetworkType(NetworkType.CONNECTED)
            .setRequiresBatteryNotLow(true) // ë°°í„°ë¦¬ ì ˆì•½
            .build()
    ).build()

    WorkManager.getInstance(context).enqueueUniquePeriodicWork(
        "widget_update",
        ExistingPeriodicWorkPolicy.KEEP,
        updateRequest
    )
}
```

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** WorkManager ìƒíƒœ í™•ì¸ í™”ë©´ (adb shell dumpsys jobscheduler)

---

### 2.3 ì¡°ê±´ë¶€ ì—…ë°ì´íŠ¸

```kotlin
class SmartRefreshAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        val prefs = context.dataStoreFile("glance_${glanceId}")
            .let { DataStoreFactory.create(PreferencesSerializer) { it } }
            .data.first()

        val lastUpdate = prefs[longPreferencesKey("last_update")] ?: 0L
        val now = System.currentTimeMillis()

        // 5ë¶„ ì´ë‚´ ì—…ë°ì´íŠ¸ëŠ” ìŠ¤í‚µ
        if (now - lastUpdate < 5 * 60 * 1000) {
            Log.d("SmartRefresh", "Too soon, skipping update")
            return
        }

        // ì‹¤ì œ ì—…ë°ì´íŠ¸ ìˆ˜í–‰
        updateAppWidgetState(context, glanceId) { mutablePrefs ->
            mutablePrefs[longPreferencesKey("last_update")] = now
            // ë°ì´í„° ê°±ì‹ ...
        }

        MyWidget().update(context, glanceId)
    }
}
```

---

## 3. UI ë Œë”ë§ ìµœì í™”

### 3.1 ë‹¨ìˆœí•œ ë ˆì´ì•„ì›ƒ ìœ ì§€

**âŒ ë³µì¡í•œ ë ˆì´ì•„ì›ƒ (ëŠë¦¼)**
```kotlin
Column {
    repeat(50) { index ->
        Row {
            Image(ImageProvider(R.drawable.icon))
            Column {
                Text("Item $index")
                Text("Description...")
                Row {
                    Button("A", onClick = {})
                    Button("B", onClick = {})
                    Button("C", onClick = {})
                }
            }
        }
    }
}
```

**âœ… ë‹¨ìˆœí•œ ë ˆì´ì•„ì›ƒ (ë¹ ë¦„)**
```kotlin
Column(modifier = GlanceModifier.fillMaxSize().padding(16.dp)) {
    Text("Title", style = TextStyle(fontSize = 18.sp, fontWeight = FontWeight.Bold))
    Spacer(GlanceModifier.height(8.dp))
    Text("Essential info only")
    Button("Action", onClick = actionRunCallback<MainAction>())
}
```

**[ë¹„êµ ì¶”ì²œ]** ë³µì¡í•œ ë ˆì´ì•„ì›ƒ vs ë‹¨ìˆœí•œ ë ˆì´ì•„ì›ƒ ë Œë”ë§ ì‹œê°„ ë¹„êµ

---

### 3.2 ì¡°ê±´ë¶€ ë Œë”ë§ ìµœì í™”

```kotlin
@Composable
fun OptimizedContent() {
    val prefs = currentState<Preferences>()
    val isExpanded = prefs[booleanPreferencesKey("is_expanded")] ?: false
    val dataCount = prefs[intPreferencesKey("data_count")] ?: 0

    Column {
        Text("Title")

        // í•„ìš”í•  ë•Œë§Œ ë Œë”ë§
        if (isExpanded && dataCount > 0) {
            HeavyContent(dataCount)
        } else {
            Text("Tap to expand")
        }
    }
}

@Composable
fun HeavyContent(count: Int) {
    // ë§ì€ í•­ëª©ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ
    Column {
        repeat(minOf(count, 5)) { index ->
            Text("Item $index")
        }
        if (count > 5) {
            Text("... and ${count - 5} more")
        }
    }
}
```

---

### 3.3 ì´ë¯¸ì§€ ìµœì í™”

```kotlin
// âŒ í° ì´ë¯¸ì§€ ì§ì ‘ ë¡œë“œ
Image(
    provider = ImageProvider(R.drawable.large_image), // 5MB ì´ë¯¸ì§€
    contentDescription = "Large"
)

// âœ… ì ì ˆí•œ í¬ê¸°ì˜ ì´ë¯¸ì§€
Image(
    provider = ImageProvider(R.drawable.icon_small), // 50KB ì´ë¯¸ì§€
    contentDescription = "Icon",
    modifier = GlanceModifier.size(48.dp)
)

// âœ… ë„¤íŠ¸ì›Œí¬ ì´ë¯¸ì§€ëŠ” ìºì‹± + ë¦¬ì‚¬ì´ì§•
suspend fun loadOptimizedImage(url: String, targetSize: Int): Bitmap {
    return imageLoader.execute(
        ImageRequest.Builder(context)
            .data(url)
            .size(targetSize, targetSize)
            .diskCachePolicy(CachePolicy.ENABLED)
            .memoryCachePolicy(CachePolicy.ENABLED)
            .build()
    ).drawable?.toBitmap() ?: createPlaceholder()
}
```

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** ì´ë¯¸ì§€ í¬ê¸°ë³„ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¹„êµ

---

## 4. ë©”ëª¨ë¦¬ ìµœì í™”

### 4.1 ìƒíƒœ í¬ê¸° ìµœì†Œí™”

**âŒ ë¶ˆí•„ìš”í•œ ë°ì´í„° ì €ì¥**
```kotlin
updateAppWidgetState(context, glanceId) { prefs ->
    // ì „ì²´ JSON ë¬¸ìì—´ ì €ì¥ (ìˆ˜ë°± KB)
    prefs[stringPreferencesKey("full_data")] = jsonString

    // ë¹„íŠ¸ë§µ ì§ì ‘ ì €ì¥ (ìˆ˜ MB)
    prefs[stringPreferencesKey("image_base64")] = base64EncodedImage
}
```

**âœ… í•„ìš”í•œ ë°ì´í„°ë§Œ ì €ì¥**
```kotlin
updateAppWidgetState(context, glanceId) { prefs ->
    // í•„ìˆ˜ í•„ë“œë§Œ ì €ì¥
    prefs[stringPreferencesKey("title")] = data.title
    prefs[intPreferencesKey("count")] = data.count
    prefs[longPreferencesKey("timestamp")] = data.timestamp

    // ì´ë¯¸ì§€ëŠ” URI/ê²½ë¡œë§Œ ì €ì¥
    prefs[stringPreferencesKey("image_uri")] = data.imageUrl
}

// ë³µì¡í•œ ë°ì´í„°ëŠ” Roomì— ì €ì¥
database.widgetDao().insert(WidgetData(glanceId, fullData))
```

---

### 4.2 ë°ì´í„° ì •ë¦¬

```kotlin
class CleanupWidgetDataWorker(context: Context, params: WorkerParameters)
    : CoroutineWorker(context, params) {

    override suspend fun doWork(): Result {
        val manager = GlanceAppWidgetManager(applicationContext)
        val activeGlanceIds = manager.getGlanceIds(MyWidget::class.java)

        // ëª¨ë“  ì €ì¥ëœ ìƒíƒœ íŒŒì¼ í™•ì¸
        val dataDir = File(applicationContext.filesDir, "datastore")
        dataDir.listFiles()?.forEach { file ->
            val glanceIdInFile = extractGlanceIdFromFilename(file.name)

            // í™œì„± ìœ„ì ¯ì´ ì•„ë‹ˆë©´ ì‚­ì œ
            if (glanceIdInFile !in activeGlanceIds.map { it.toString() }) {
                file.delete()
                Log.d("Cleanup", "Deleted orphaned state: ${file.name}")
            }
        }

        return Result.success()
    }
}

// Receiverì—ì„œ ì‚­ì œ ì‹œ ì •ë¦¬
override fun onDeleted(context: Context, appWidgetIds: IntArray) {
    super.onDeleted(context, appWidgetIds)

    appWidgetIds.forEach { appWidgetId ->
        val glanceId = GlanceAppWidgetManager(context).getGlanceIdBy(appWidgetId)

        // ìƒíƒœ íŒŒì¼ ì‚­ì œ
        val file = context.dataStoreFile("glance_${glanceId}")
        file.delete()

        // DB ë°ì´í„° ì‚­ì œ
        CoroutineScope(Dispatchers.IO).launch {
            database.widgetDao().deleteByGlanceId(glanceId.toString())
        }
    }
}
```

---

## 5. ë„¤íŠ¸ì›Œí¬ ìµœì í™”

### 5.1 íš¨ìœ¨ì ì¸ ë°ì´í„° í˜ì¹­

```kotlin
class OptimizedDataRepository {
    private val cache = LruCache<String, CachedData>(maxSize = 10)

    suspend fun fetchData(forceRefresh: Boolean = false): WidgetData {
        val cacheKey = "widget_data"

        // ìºì‹œ í™•ì¸
        if (!forceRefresh) {
            cache.get(cacheKey)?.let { cached ->
                val ageMinutes = (System.currentTimeMillis() - cached.timestamp) / 60000
                if (ageMinutes < 15) {
                    Log.d("Repository", "Using cached data (${ageMinutes}min old)")
                    return cached.data
                }
            }
        }

        // API í˜¸ì¶œ
        return withContext(Dispatchers.IO) {
            try {
                val data = api.fetchWidgetData()
                cache.put(cacheKey, CachedData(data, System.currentTimeMillis()))
                data
            } catch (e: Exception) {
                // ìºì‹œ í´ë°±
                cache.get(cacheKey)?.data ?: throw e
            }
        }
    }

    data class CachedData(val data: WidgetData, val timestamp: Long)
}
```

---

### 5.2 ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸

```kotlin
class NetworkAwareAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        val connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE)
            as ConnectivityManager

        val network = connectivityManager.activeNetwork
        val capabilities = connectivityManager.getNetworkCapabilities(network)

        if (capabilities == null ||
            !capabilities.hasCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET)) {
            // ë„¤íŠ¸ì›Œí¬ ì—†ìŒ
            updateAppWidgetState(context, glanceId) { prefs ->
                prefs[stringPreferencesKey("status")] = "offline"
                prefs[stringPreferencesKey("message")] = "ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì—†ìŒ"
            }
            MyWidget().update(context, glanceId)
            return
        }

        // ë„¤íŠ¸ì›Œí¬ ìˆìŒ, ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        fetchAndUpdateData(context, glanceId)
    }
}
```

---

## 6. ë°°í„°ë¦¬ íš¨ìœ¨ì„± ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 6.1 Doze ëª¨ë“œ ëŒ€ì‘

```kotlin
// WorkManagerëŠ” ìë™ìœ¼ë¡œ Doze ëª¨ë“œ ì²˜ë¦¬
val constraints = Constraints.Builder()
    .setRequiresBatteryNotLow(true) // ë°°í„°ë¦¬ ë¶€ì¡± ì‹œ ì‹¤í–‰ ì•ˆ í•¨
    .setRequiresDeviceIdle(false) // Idle í•„ìš” ì—†ìŒ
    .build()

val workRequest = PeriodicWorkRequestBuilder<WidgetUpdateWorker>(
    repeatInterval = 30,
    repeatIntervalTimeUnit = TimeUnit.MINUTES
).setConstraints(constraints)
    .setBackoffCriteria(
        BackoffPolicy.EXPONENTIAL,
        WorkRequest.MIN_BACKOFF_MILLIS,
        TimeUnit.MILLISECONDS
    )
    .build()
```

---

### 6.2 ì ˆì „ ëª¨ë“œ ê°ì§€

```kotlin
class PowerSavingWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        val powerManager = context.getSystemService(Context.POWER_SERVICE) as PowerManager
        val isPowerSaveMode = powerManager.isPowerSaveMode

        provideContent {
            Column {
                if (isPowerSaveMode) {
                    Text("ì ˆì „ ëª¨ë“œ - ìë™ ì—…ë°ì´íŠ¸ ì¤‘ì§€")
                    Button("ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨", onClick = actionRunCallback<ManualRefreshAction>())
                } else {
                    NormalContent()
                }
            }
        }
    }
}
```

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** ì ˆì „ ëª¨ë“œ ON/OFF ì‹œ ìœ„ì ¯ UI ë³€í™”

---

## 7. ì¢…í•© ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì²´í¬ë¦¬ìŠ¤íŠ¸

### âœ… ì—…ë°ì´íŠ¸
- [ ] ì‚¬ìš©ì íŠ¸ë¦¬ê±° ê¸°ë°˜ ì—…ë°ì´íŠ¸ ìš°ì„ 
- [ ] ìë™ ì—…ë°ì´íŠ¸ëŠ” 15ë¶„ ì´ìƒ ì£¼ê¸°
- [ ] ì¡°ê±´ë¶€ ì—…ë°ì´íŠ¸ ë¡œì§ êµ¬í˜„ (ì‹œê°„ ì²´í¬)
- [ ] WorkManager Constraints í™œìš© (ë„¤íŠ¸ì›Œí¬, ë°°í„°ë¦¬)

### âœ… UI
- [ ] ë‹¨ìˆœí•œ ë ˆì´ì•„ì›ƒ (ê¹Šì´ 5 ì´í•˜)
- [ ] í•­ëª© ê°œìˆ˜ ì œí•œ (10ê°œ ì´í•˜)
- [ ] ì´ë¯¸ì§€ ìµœì í™” (50KB ì´í•˜ ê¶Œì¥)
- [ ] ì¡°ê±´ë¶€ ë Œë”ë§ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±°

### âœ… ìƒíƒœ
- [ ] ì‘ì€ ë°ì´í„°ë§Œ ì €ì¥ (ìˆ˜ì‹­ KB ì´í•˜)
- [ ] ë³µì¡í•œ ë°ì´í„°ëŠ” Room/File í™œìš©
- [ ] ìœ„ì ¯ ì‚­ì œ ì‹œ ë°ì´í„° ì •ë¦¬
- [ ] ê¸°ë³¸ê°’ í•­ìƒ ì œê³µ

### âœ… ë„¤íŠ¸ì›Œí¬
- [ ] ìºì‹± ì „ëµ êµ¬í˜„
- [ ] ë„¤íŠ¸ì›Œí¬ ìƒíƒœ í™•ì¸
- [ ] ì‹¤íŒ¨ ì‹œ í´ë°± ì²˜ë¦¬
- [ ] íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ì´ˆ ì´í•˜)

### âœ… ë°°í„°ë¦¬
- [ ] Doze ëª¨ë“œ ê³ ë ¤
- [ ] ì ˆì „ ëª¨ë“œ ê°ì§€ ë° ëŒ€ì‘
- [ ] ë¶ˆí•„ìš”í•œ wake lock íšŒí”¼
- [ ] ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ìµœì†Œí™”

---

## 8. ì•ˆí‹° íŒ¨í„´

### âŒ í”¼í•´ì•¼ í•  ê²ƒë“¤

```kotlin
// 1. ì§§ì€ ì£¼ê¸° ë°˜ë³µ ì—…ë°ì´íŠ¸
setInterval(1000) { updateWidget() } // ì ˆëŒ€ ê¸ˆì§€!

// 2. ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œ
provideGlance {
    val data = apiService.fetchData() // ë¸”ë¡œí‚¹!
}

// 3. ê±°ëŒ€í•œ ìƒíƒœ ì €ì¥
prefs[stringPreferencesKey("data")] = 5MBJsonString

// 4. ì „ì—­ ë³€ìˆ˜ë¡œ ìƒíƒœ ê´€ë¦¬
companion object {
    var widgetData = ... // í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œ ì†ì‹¤
}

// 5. ë¬´í•œ ì¬ê·€ ì—…ë°ì´íŠ¸
class BadAction : ActionCallback {
    override suspend fun onAction(...) {
        updateAppWidgetState(...) { ... }
        MyWidget().update(context, glanceId)
        // ë˜ ë‹¤ë¥¸ Action íŠ¸ë¦¬ê±° â†’ ë¬´í•œ ë£¨í”„!
        SomeOtherAction().onAction(...)
    }
}
```

---

## 9. ì„±ëŠ¥ ì¸¡ì •

### 9.1 ë Œë”ë§ ì‹œê°„ ì¸¡ì •

```kotlin
class MeasuredWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        val startTime = System.currentTimeMillis()

        provideContent {
            WidgetContent()
        }

        val renderTime = System.currentTimeMillis() - startTime
        Log.d("Performance", "Render time: ${renderTime}ms")

        // Analytics ì „ì†¡
        FirebaseAnalytics.getInstance(context).logEvent("widget_render") {
            param("render_time_ms", renderTime)
            param("glance_id", id.toString())
        }
    }
}
```

### 9.2 ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸

```bash
# ìœ„ì ¯ í”„ë¡œì„¸ìŠ¤ ë©”ëª¨ë¦¬ í™•ì¸
adb shell dumpsys meminfo <your.package.name>

# íŠ¹ì • ìœ„ì ¯ì˜ DataStore í¬ê¸°
adb shell ls -lh /data/data/<your.package>/files/datastore/
```

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** adb meminfo ì¶œë ¥ ê²°ê³¼

---

---
