> [!TIP] 🗣️ 핵심내용
Glance를 프로젝트에 통합하기 위한 Gradle 설정과 필수 라이브러리를 알아봅니다.
>

## 1. Gradle 설정

### 1.1 프로젝트 레벨 build.gradle.kts

```kotlin
// 프로젝트 루트의 build.gradle.kts
plugins {
    id("com.android.application") version "8.2.0" apply false
    id("org.jetbrains.kotlin.android") version "1.9.20" apply false
}
```

---

### 1.2 모듈 레벨 build.gradle.kts

```kotlin
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
}

android {
    namespace = "com.example.glancewidget"
    compileSdk = 34

    defaultConfig {
        applicationId = "com.example.glancewidget"
        minSdk = 23  // Glance 최소 API 23
        targetSdk = 34
        versionCode = 1
        versionName = "1.0"
    }

    buildFeatures {
        compose = true
    }

    composeOptions {
        kotlinCompilerExtensionVersion = "1.5.4"
    }

    kotlinOptions {
        jvmTarget = "1.8"
    }
}

dependencies {
    // 필수: Glance 위젯 라이브러리
    implementation("androidx.glance:glance-appwidget:1.1.1")

    // 추천: Material3 테마 지원
    implementation("androidx.glance:glance-material3:1.1.0")

    // 필수: 상태 관리용 DataStore
    implementation("androidx.datastore:datastore-preferences:1.1.1")

    // 추천: 백그라운드 작업용 WorkManager
    implementation("androidx.work:work-runtime-ktx:2.9.0")
}
```

---

## 2. 의존성 설명

### 2.1 핵심 의존성

| 라이브러리 | 버전 | 필수 여부 | 설명 |
|-----------|------|----------|------|
| `glance-appwidget` | 1.1.1 | ✅ 필수 | Glance 위젯 핵심 라이브러리 |
| `datastore-preferences` | 1.1.1 | ✅ 필수 | 위젯 상태 저장용 |

### 2.2 추천 의존성

| 라이브러리 | 버전 | 용도 |
|-----------|------|------|
| `glance-material3` | 1.1.0 | Material3 디자인 컴포넌트 |
| `work-runtime-ktx` | 2.9.0 | 주기적 업데이트, 백그라운드 작업 |

### 2.3 Proto DataStore 사용 시 추가 의존성

복잡한 데이터 구조를 다룰 때 Proto DataStore를 사용하려면 추가 의존성이 필요합니다.

| 라이브러리 | 버전 | 용도 |
|-----------|------|------|
| `datastore` (core) | 1.0.0 | Proto DataStore 코어 |
| `protobuf-javalite` | 3.21.12 | Protocol Buffers 런타임 |
| Protobuf 플러그인 | 0.9.4 | .proto 파일 컴파일 |

> [!NOTE]
> Proto DataStore는 복잡한 데이터 구조(중첩 객체, 리스트 등)를 저장할 때 사용합니다. 간단한 key-value 저장만 필요하다면 `datastore-preferences`만 사용하면 됩니다.

---

## 3. Proto DataStore 사용 시 추가 설정

> [!NOTE] 💬 발표 설명
> "**Proto DataStore는 Glance 전용이 아닙니다**. 일반 Android 앱에서도 사용하는 Jetpack DataStore의 한 종류입니다.
>
> - **Preferences DataStore**: 간단한 key-value 저장 (Int, String, Boolean 등)
> - **Proto DataStore**: 복잡한 데이터 구조를 Protocol Buffers로 저장 (중첩 객체, 리스트 등)
>
> Glance 위젯에서는 **위젯 상태가 복잡할 때** Proto DataStore를 선택할 수 있습니다. 예를 들어:
> - Todo 리스트 (각 항목이 제목, 완료 여부, 우선순위 등의 필드를 가짐)
> - 날씨 정보 (온도, 습도, 풍속, 예보 리스트 등)
> - 설정 정보 (여러 카테고리와 하위 옵션들)
>
> 일반 앱에서도 동일한 목적으로 사용됩니다. Glance만의 기능이 아니라 **Android 전반에서 쓰는 데이터 저장 방식**입니다."

복잡한 데이터 구조를 다룰 때는 Protocol Buffers를 사용할 수 있습니다.

### 3.1 Protobuf 플러그인 추가

```kotlin
// 모듈 레벨 build.gradle.kts
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
    id("com.google.protobuf") version "0.9.4"  // 추가
}

dependencies {
    // Proto DataStore
    implementation("androidx.datastore:datastore:1.0.0")
    implementation("com.google.protobuf:protobuf-javalite:3.21.12")
}

protobuf {
    protoc {
        artifact = "com.google.protobuf:protoc:3.21.12"
    }
    generateProtoTasks {
        all().forEach { task ->
            task.builtins {
                create("java") {
                    option("lite")
                }
            }
        }
    }
}
```

### 3.2 Proto 파일 위치

```
app/
└── src/
    └── main/
        ├── proto/
        │   └── widget_state.proto  ← 여기에 .proto 파일 생성
        └── java/
```

**[스크린샷 추천]** Android Studio 프로젝트 구조에서 proto 폴더 위치

---

## 4. 버전 카탈로그 사용 (권장)

최신 프로젝트는 `libs.versions.toml`을 사용합니다.

### 4.1 gradle/libs.versions.toml

```toml
[versions]
glance = "1.1.1"
glanceMaterial = "1.1.0"
datastore = "1.1.1"
work = "2.9.0"
compose = "1.5.4"

[libraries]
glance-appwidget = { module = "androidx.glance:glance-appwidget", version.ref = "glance" }
glance-material3 = { module = "androidx.glance:glance-material3", version.ref = "glanceMaterial" }
datastore-preferences = { module = "androidx.datastore:datastore-preferences", version.ref = "datastore" }
work-runtime = { module = "androidx.work:work-runtime-ktx", version.ref = "work" }

[bundles]
glance = ["glance-appwidget", "glance-material3", "datastore-preferences"]
```

### 4.2 build.gradle.kts에서 사용

```kotlin
dependencies {
    // 번들로 한 번에 추가
    implementation(libs.bundles.glance)
    implementation(libs.work.runtime)

    // 또는 개별 추가
    implementation(libs.glance.appwidget)
    implementation(libs.glance.material3)
}
```

---

## 5. AndroidManifest.xml 권한 설정

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">

    <!-- 인터넷 사용 (API 호출 시) -->
    <uses-permission android:name="android.permission.INTERNET" />

    <!-- 네트워크 상태 확인 (선택) -->
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

    <application
        android:name=".MyApplication"
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:theme="@style/Theme.MyApp">

        <!-- 위젯 Receiver 등록 -->
        <receiver
            android:name=".widget.MyWidgetReceiver"
            android:exported="true">
            <intent-filter>
                <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
            </intent-filter>
            <meta-data
                android:name="android.appwidget.provider"
                android:resource="@xml/my_widget_info" />
        </receiver>

    </application>

</manifest>
```

---

## 6. ProGuard / R8 규칙

release 빌드 시 난독화로 인한 문제를 방지합니다.

> [!NOTE] 💬 발표 설명
> "Release 빌드할 때 **ProGuard/R8 규칙**이 중요합니다. 안 넣으면 위젯이 런타임에 크래시 날 수 있어요.
>
> Glance는 **리플렉션**으로 클래스를 동적으로 생성합니다. ActionCallback, GlanceAppWidget, GlanceAppWidgetReceiver 같은 클래스들을 시스템이 런타임에 찾아서 인스턴스를 만들어요.
>
> 근데 ProGuard가 난독화하면 클래스 이름이 `a`, `b`, `c` 같은 걸로 바뀌고, 안 쓰는 것처럼 보이는 생성자는 아예 제거됩니다. 그러면 Glance가 클래스를 못 찾거나 생성자를 못 호출해서 크래시가 나죠.
>
> `-keep class` 규칙은 '이 클래스는 난독화하지 마' 라는 뜻이고, `public <init>()` 규칙은 '기본 생성자 제거하지 마'라는 뜻입니다. WorkManager의 Worker 클래스도 마찬가지 이유로 keep이 필요합니다."

### 6.1 proguard-rules.pro

```proguard
# Glance
-keep class androidx.glance.** { *; }
-dontwarn androidx.glance.**

# DataStore
-keep class androidx.datastore.** { *; }
-dontwarn androidx.datastore.**

# Protobuf (Proto DataStore 사용 시)
-keep class * extends com.google.protobuf.GeneratedMessageLite { *; }

# WorkManager
-keep class * extends androidx.work.Worker
-keep class * extends androidx.work.CoroutineWorker

# ActionCallback
-keep class * implements androidx.glance.action.ActionCallback {
    public <init>();
}

# GlanceAppWidget
-keep class * extends androidx.glance.appwidget.GlanceAppWidget {
    public <init>();
}

# GlanceAppWidgetReceiver
-keep class * extends androidx.glance.appwidget.GlanceAppWidgetReceiver {
    public <init>();
}
```

**[스크린샷 추천]** ProGuard 설정 파일 위치 (app/proguard-rules.pro)

---

## 7. 의존성 확인

### 7.1 Gradle Sync
```bash
# Android Studio에서
File > Sync Project with Gradle Files
```

### 7.2 의존성 트리 확인
```bash
./gradlew :app:dependencies
```

출력 예시:
```
+--- androidx.glance:glance-appwidget:1.0.0
|    +--- androidx.glance:glance:1.0.0
|    +--- androidx.datastore:datastore-preferences:1.0.0
|    \--- androidx.compose.ui:ui:1.5.4
+--- androidx.glance:glance-material3:1.0.0
...
```

---

## 8. 버전 호환성

### 8.1 최소 요구사항

| 항목                    | 버전               |
| --------------------- | ---------------- |
| Android Gradle Plugin | 7.0+             |
| Kotlin                | 1.8.0+           |
| minSdk                | 23 (Android 6.0) |
| compileSdk            | 33+              |
| Compose Compiler      | 1.5.0+           |

### 8.2 권장 버전

| 항목 | 버전 |
|------|------|
| Android Gradle Plugin | 8.2.0+ |
| Kotlin | 1.9.20+ |
| targetSdk | 34 |
| Compose Compiler | 1.5.4+ |

---

## 9. 일반적인 문제 해결

### 9.1 "Unresolved reference: glance"

**원인**: Gradle Sync가 완료되지 않음

**해결**:
```bash
# 1. Clean & Rebuild
./gradlew clean build

# 2. Invalidate Caches
Android Studio > File > Invalidate Caches > Invalidate and Restart
```

---

### 9.2 "Duplicate class androidx.glance..."

**원인**: 중복 의존성

**해결**: build.gradle.kts에서 중복 제거
```kotlin
dependencies {
    implementation("androidx.glance:glance-appwidget:1.0.0")
    // ❌ implementation("androidx.glance:glance:1.0.0")  // 중복, 제거

    implementation("androidx.glance:glance-material3:1.0.0")
}
```

---

### 9.3 Proto 파일 빌드 실패

**원인**: Protobuf 플러그인 설정 오류

**해결**:
```kotlin
// 1. 플러그인 버전 확인
plugins {
    id("com.google.protobuf") version "0.9.4"
}

// 2. Sync 후 Build > Rebuild Project
```

---

## 10. 체크리스트

### 기본 설정
- [ ] `glance-appwidget` 의존성 추가
- [ ] `datastore-preferences` 의존성 추가
- [ ] `glance-material3` 의존성 추가 (추천)
- [ ] `work-runtime-ktx` 의존성 추가 (추천)
- [ ] Compose 설정 (`buildFeatures.compose = true`)
- [ ] minSdk 23 이상 설정
- [ ] AndroidManifest.xml에 Receiver 등록
- [ ] ProGuard 규칙 추가 (release 빌드 시)
- [ ] Gradle Sync 성공

### Proto DataStore 사용 시 추가
- [ ] `datastore` (core) 의존성 추가
- [ ] `protobuf-javalite` 의존성 추가
- [ ] Protobuf 플러그인 설정
- [ ] `app/src/main/proto/` 디렉토리 생성
- [ ] Protobuf 규칙을 ProGuard에 추가

---

---
