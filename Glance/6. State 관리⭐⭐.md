> [!TIP] ğŸ—£ï¸ í•µì‹¬ë‚´ìš©
ìœ„ì ¯ì˜ ìƒíƒœë¥¼ ì €ì¥í•˜ê³  ë³µì›í•˜ëŠ” ë°©ë²•. `currentState()`, `updateAll()`, `update()`ë¥¼ í™œìš©í•œ ë°ì´í„° ê´€ë¦¬ë¥¼ ë°°ì›ë‹ˆë‹¤.
>

## 1. State ê´€ë¦¬ ê°œìš”

Glance ìœ„ì ¯ì€ **ì¸ìŠ¤í„´ìŠ¤ë³„ë¡œ ë…ë¦½ì ì¸ ìƒíƒœ**ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í™ˆ í™”ë©´ì— ê°™ì€ ìœ„ì ¯ì„ ì—¬ëŸ¬ ê°œ ì¶”ê°€í•˜ë©´ ê°ê° ë‹¤ë¥¸ ë°ì´í„°ë¥¼ ë³´ì—¬ì¤„ ìˆ˜ ìˆë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.

```
ğŸ“± í™ˆ í™”ë©´
   â”œâ”€ ìœ„ì ¯ A (`GlanceId`: 123) â†’ State A
   â”œâ”€ ìœ„ì ¯ B (`GlanceId`: 456) â†’ State B
   â””â”€ ìœ„ì ¯ C (`GlanceId`: 789) â†’ State C
```

### 1.1 ì „í†µ ìœ„ì ¯ê³¼ì˜ ìƒíƒœ ê´€ë¦¬ ë¹„êµ

**ì „í†µ ìœ„ì ¯ (SharedPreferences ì§ì ‘ êµ¬í˜„)**
```kotlin
class TraditionalWidget : AppWidgetProvider() {
    override fun onUpdate(
        context: Context,
        appWidgetManager: AppWidgetManager,
        appWidgetIds: IntArray
    ) {
        appWidgetIds.forEach { appWidgetId ->
            // 1. SharedPreferencesì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ìƒíƒœ ì½ê¸°
            val prefs = context.getSharedPreferences("widget_$appWidgetId", Context.MODE_PRIVATE)
            val count = prefs.getInt("count", 0)
            val name = prefs.getString("name", "Guest") ?: "Guest"

            // 2. RemoteViews ìƒì„± ë° ì„¤ì •
            val views = RemoteViews(context.packageName, R.layout.widget_layout)
            views.setTextViewText(R.id.count_text, "Count: $count")
            views.setTextViewText(R.id.name_text, "Name: $name")

            // 3. ë²„íŠ¼ í´ë¦­ ì‹œ BroadcastReceiverë¡œ ì „ë‹¬
            val intent = Intent(context, IncrementReceiver::class.java)
            intent.putExtra("widget_id", appWidgetId)
            val pendingIntent = PendingIntent.getBroadcast(
                context, appWidgetId, intent, PendingIntent.FLAG_UPDATE_CURRENT
            )
            views.setOnClickPendingIntent(R.id.increment_button, pendingIntent)

            appWidgetManager.updateAppWidget(appWidgetId, views)
        }
    }
}

// ë³„ë„ BroadcastReceiverë¡œ ìƒíƒœ ë³€ê²½ ì²˜ë¦¬
class IncrementReceiver : BroadcastReceiver() {
    override fun onReceive(context: Context, intent: Intent) {
        val widgetId = intent.getIntExtra("widget_id", -1)

        // 1. SharedPreferencesì—ì„œ ì½ê¸°
        val prefs = context.getSharedPreferences("widget_$widgetId", Context.MODE_PRIVATE)
        val currentCount = prefs.getInt("count", 0)

        // 2. ìƒíƒœ ë³€ê²½
        prefs.edit().putInt("count", currentCount + 1).apply()

        // 3. ìœ„ì ¯ ìˆ˜ë™ ì—…ë°ì´íŠ¸
        val appWidgetManager = AppWidgetManager.getInstance(context)
        val views = RemoteViews(context.packageName, R.layout.widget_layout)
        views.setTextViewText(R.id.count_text, "Count: ${currentCount + 1}")
        appWidgetManager.updateAppWidget(widgetId, views)
    }
}
```

**ë¬¸ì œì **:
- SharedPreferences íŒŒì¼ëª… ê´€ë¦¬ (`widget_$appWidgetId`)ë¥¼ ì§ì ‘ í•´ì•¼ í•¨
- ìƒíƒœ ì½ê¸°/ì“°ê¸° ë¡œì§ì´ ì—¬ëŸ¬ ê³³ì— ë¶„ì‚° (AppWidgetProvider, BroadcastReceiver ë“±)
- ì¸ìŠ¤í„´ìŠ¤ë³„ ìƒíƒœ ë¶„ë¦¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ êµ¬í˜„í•´ì•¼ í•¨
- íƒ€ì… ì•ˆì •ì„± ë¶€ì¡± (ë¬¸ìì—´ í‚¤ ì‚¬ìš©)
- ìƒíƒœ ë³€ê²½ í›„ UI ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬

> [!NOTE] PendingIntentë¥¼ ì“°ëŠ” ì´ìœ 
ì „í†µì ì¸ ìœ„ì ¯ì˜ UIëŠ” ì•± ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ë·°ê°€ ì•„ë‹ˆë¼ **ëŸ°ì²˜ í”„ë¡œì„¸ìŠ¤ê°€ ê·¸ë¦¬ëŠ” RemoteViews ë³µì œë³¸**ì…ë‹ˆë‹¤.
> ê·¸ë˜ì„œ ë²„íŠ¼ í´ë¦­ ê°™ì€ ì´ë²¤íŠ¸ë¥¼ ì§ì ‘ ë°›ì„ ìˆ˜ ì—†ê³ , **â€œëª…ë ¹ ì „ë‹¬â€ ë°©ì‹ìœ¼ë¡œë§Œ ì²˜ë¦¬**í•´ì•¼ í•©ë‹ˆë‹¤.
> ì¦‰, setOnClickPendingIntent()ë¡œ ëŸ°ì²˜ì— â€œì´ ë²„íŠ¼ì´ ëˆŒë¦¬ë©´ PendingIntentë¥¼ ì‹¤í–‰í•˜ë¼â€ëŠ” ì§€ì‹œë¥¼ ë³´ë‚´ê³ ,
> ëŸ°ì²˜ê°€ í´ë¦­ ì‹œ BroadcastReceiverë‚˜ Activityë¥¼ í˜¸ì¶œí•˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.

**Glance ìœ„ì ¯ (DataStore ê¸°ë°˜ StateDefinition)**
```kotlin
class ModernWidget : GlanceAppWidget() {
    // StateDefinition ì§€ì •ë§Œìœ¼ë¡œ ìƒíƒœ ê´€ë¦¬ ì¤€ë¹„ ì™„ë£Œ
    override val stateDefinition = PreferencesGlanceStateDefinition

    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            // 1. ìƒíƒœ ì½ê¸° - ì¸ìŠ¤í„´ìŠ¤ë³„ ìë™ ë¶„ë¦¬
            val prefs = currentState<Preferences>()
            val count = prefs[intPreferencesKey("count")] ?: 0
            val name = prefs[stringPreferencesKey("name")] ?: "Guest"

            Column {
                Text("Count: $count")
                Text("Name: $name")

                // 2. ë²„íŠ¼ í´ë¦­ ì‹œ ActionCallbackìœ¼ë¡œ ì²˜ë¦¬
                Button(
                    text = "Increment",
                    onClick = actionRunCallback<IncrementAction>()
                )
            }
        }
    }
}

// ìƒíƒœ ë³€ê²½ ë¡œì§ - íƒ€ì… ì•ˆì •ì„± ë³´ì¥
class IncrementAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // 1. ìƒíƒœ ë³€ê²½ - ì¸ìŠ¤í„´ìŠ¤ë³„ ìë™ ê´€ë¦¬
        updateAppWidgetState(context, glanceId) { prefs ->
            val current = prefs[intPreferencesKey("count")] ?: 0
            prefs[intPreferencesKey("count")] = current + 1
        }

        // 2. UI ì—…ë°ì´íŠ¸ - í•œ ì¤„ë¡œ ì²˜ë¦¬
        ModernWidget().update(context, glanceId)
    }
}
```

**ê°œì„ ì **:
- **ì¸ìŠ¤í„´ìŠ¤ë³„ ìƒíƒœ ìë™ ê´€ë¦¬**: GlanceId ê¸°ë°˜ìœ¼ë¡œ ìë™ ë¶„ë¦¬
- **DataStore ê¸°ë°˜**: SharedPreferencesë³´ë‹¤ ì•ˆì „í•˜ê³  ë¹„ë™ê¸° ì¹œí™”ì 
- **íƒ€ì… ì•ˆì •ì„±**: `intPreferencesKey`, `stringPreferencesKey` ë“±ìœ¼ë¡œ íƒ€ì… ë³´ì¥
- **ì¤‘ì•™í™”ëœ ë¡œì§**: ìƒíƒœ ê´€ë¦¬ê°€ `updateAppWidgetState` + `update()`ë¡œ í†µì¼
- **ì½”ë“œ ê°„ê²°ì„±**: ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ ëŒ€í­ ê°ì†Œ

> [!NOTE] ğŸ’¡ ì˜ˆì œ 1ì˜ ì´ˆì 
> ì´ ì˜ˆì œëŠ” **ì „í†µ ìœ„ì ¯ ëŒ€ë¹„ Glanceì˜ ê°œì„ ì **ì„ ê°•ì¡°í•©ë‹ˆë‹¤:
> - ìë™ ì¸ìŠ¤í„´ìŠ¤ ë¶„ë¦¬ (GlanceId ê¸°ë°˜)
> - íƒ€ì… ì•ˆì „í•œ ìƒíƒœ ê´€ë¦¬ (Typed Key)
> - ê°„ê²°í•œ ì½”ë“œ (ActionCallback í•œ ê³³ì— ì§‘ì¤‘)


**ë¹„êµ ìš”ì•½**:

| í•­ëª© | ì „í†µ ìœ„ì ¯ | Glance ìœ„ì ¯ |
|------|-----------|-------------|
| **ìƒíƒœ ì €ì¥ì†Œ** | SharedPreferences (ì§ì ‘ êµ¬í˜„) | DataStore (ìë™ ì œê³µ) |
| **ì¸ìŠ¤í„´ìŠ¤ ë¶„ë¦¬** | `widget_$appWidgetId` íŒŒì¼ëª… ìˆ˜ë™ ê´€ë¦¬ | `GlanceId` ìë™ ê´€ë¦¬ |
| **íƒ€ì… ì•ˆì •ì„±** | ë¬¸ìì—´ í‚¤ (íƒ€ì… ë¶ˆì•ˆì •) | Typed Key (íƒ€ì… ì•ˆì •) |
| **ìƒíƒœ ë³€ê²½ íë¦„** | ì½ê¸° â†’ ë³€ê²½ â†’ ì €ì¥ â†’ UI ì—…ë°ì´íŠ¸ (4ë‹¨ê³„) | `updateAppWidgetState` + `update()` (2ë‹¨ê³„) |
| **ì½”ë“œ ë¶„ì‚°** | AppWidgetProvider, BroadcastReceiver ë“± ì—¬ëŸ¬ ê³³ | ActionCallback í•œ ê³³ì— ì§‘ì¤‘ |
| **ë¹„ë™ê¸° ì§€ì›** | ìˆ˜ë™ êµ¬í˜„ í•„ìš” | Coroutine ê¸°ë°˜ ìë™ ì§€ì› |

---

### 1.2 íƒ€ì… ì•ˆì •ì„±: SharedPreferences vs DataStore

Glance DataStoreì˜ **Typed Key ì‹œìŠ¤í…œ**ì€ ì „í†µ ìœ„ì ¯ì˜ SharedPreferences ë¬¸ìì—´ í‚¤ ë°©ì‹ê³¼ ë¹„êµí–ˆì„ ë•Œ **íƒ€ì… ì•ˆì •ì„± ì¸¡ë©´ì—ì„œ í° ì°¨ì´**ê°€ ìˆìŠµë‹ˆë‹¤.

**í•µì‹¬ ì°¨ì´ì **:

```kotlin
// âŒ SharedPreferences - ë¬¸ìì—´ í‚¤ (íƒ€ì… ë¶ˆì•ˆì •)
prefs.edit().putInt("count", 42).apply()
val count = prefs.getString("count", "0") // ëŸ°íƒ€ì„ í¬ë˜ì‹œ! ClassCastException

// âœ… Glance DataStore - Typed Key (íƒ€ì… ì•ˆì •)
val countKey = intPreferencesKey("count")
prefs[countKey] = 42 // âœ…
prefs[countKey] = "text" // âŒ ì»´íŒŒì¼ ì—ëŸ¬! Type mismatch
```

**íƒ€ì… ì•ˆì •ì„±ì˜ í•µì‹¬ ê°€ì¹˜**:
- **ì»´íŒŒì¼ íƒ€ì„ íƒ€ì… ì²´í¬**: íƒ€ì… ë¶ˆì¼ì¹˜ë¥¼ ì½”ë“œ ì‘ì„± ë‹¨ê³„ì—ì„œ ë°œê²¬
- **ì˜¤íƒ€ ë°©ì§€**: IDE ìë™ì™„ì„±ìœ¼ë¡œ í‚¤ ì´ë¦„ ì‹¤ìˆ˜ ì›ì²œ ì°¨ë‹¨
- **ì•ˆì „í•œ ë¦¬íŒ©í† ë§**: Refactor > Renameìœ¼ë¡œ ëª¨ë“  ì‚¬ìš©ì²˜ ìë™ ë³€ê²½
- **í˜‘ì—… ì•ˆì „ì„±**: ì—¬ëŸ¬ ê°œë°œìê°€ ê°™ì€ í‚¤ë¥¼ ë‹¤ë¥¸ íƒ€ì…ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì»´íŒŒì¼ëŸ¬ê°€ ë°©ì§€

> [!TIP] ğŸ“š ìƒì„¸ ë¬¸ì„œ
> íƒ€ì… ì•ˆì •ì„±ì— ëŒ€í•œ **ì‹¬ì¸µ ë¶„ì„**(6ê°€ì§€ ë¬¸ì œì , 6ê°€ì§€ í•´ê²°ì±…, ì‹¤ì „ ì˜ˆì œ, ë¹„êµí‘œ)ì€ ë³„ë„ ë¬¸ì„œì—ì„œ í™•ì¸í•˜ì„¸ìš”:
>
> **[[6.1. íƒ€ì… ì•ˆì •ì„± ìƒì„¸ ë¹„êµâ­]]**

**ë¹„êµ ìš”ì•½**:

| ì¸¡ë©´         | ì „í†µ ìœ„ì ¯ (SharedPreferences)  | Glance ìœ„ì ¯ (DataStore)        |
| ---------- | -------------------------- | ---------------------------- |
| **í‚¤ íƒ€ì…**   | String (íƒ€ì… ì—†ìŒ)             | `Preferences.Key<T>` (íƒ€ì… ìˆìŒ) |
| **íƒ€ì… ì²´í¬**  | ëŸ°íƒ€ì„                        | ì»´íŒŒì¼ íƒ€ì„                       |
| **ì˜¤íƒ€ ê°ì§€**  | âŒ ë¶ˆê°€ëŠ¥ (0/null ë°˜í™˜)          | âœ… ê°€ëŠ¥ (ì»´íŒŒì¼ ì—ëŸ¬)                |
| **íƒ€ì… ë¶ˆì¼ì¹˜** | âŒ ClassCastException (í¬ë˜ì‹œ) | âœ… ì»´íŒŒì¼ ì—ëŸ¬ (ì‚¬ì „ ë°©ì§€)             |
| **ìë™ì™„ì„±**   | âŒ ì—†ìŒ                       | âœ… ì™„ë²½ ì§€ì›                      |
| **ë¦¬íŒ©í† ë§**   | âŒ ìˆ˜ë™ ê²€ìƒ‰ í•„ìš”                 | âœ… IDE Refactor ê°€ëŠ¥            |
| **í˜‘ì—… ì•ˆì „ì„±** | âŒ ë‚®ìŒ (ë¬¸ìì—´ ì¶©ëŒ)              | âœ… ë†’ìŒ (ì»´íŒŒì¼ ë³´ì¥)                |

---

## 2. `StateDefinition` ì¢…ë¥˜

### 2.1 `PreferencesGlanceStateDefinition` (ê°€ì¥ ë§ì´ ì‚¬ìš©)
- **ê°„ë‹¨í•œ key-value ë°ì´í„°**ì— ì í•©
- DataStore Preferences ê¸°ë°˜
- íƒ€ì…: `Int`, `String`, `Boolean`, `Long`, `Float`, `Double`, `Set<String>`

```kotlin
class SimpleWidget : GlanceAppWidget() {
    // StateDefinition ì§€ì •
    override val stateDefinition = PreferencesGlanceStateDefinition

    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            // 1. í˜„ì¬ ìƒíƒœ ì½ê¸°
            val prefs = currentState<Preferences>()
            val count = prefs[intPreferencesKey("count")] ?: 0
            val name = prefs[stringPreferencesKey("name")] ?: "Guest"
            val isActive = prefs[booleanPreferencesKey("is_active")] ?: false

            Column {
                Text("Count: $count")
                Text("Name: $name")
                Text("Active: $isActive")
            }
        }
    }
}
```

---

### 2.2 `ProtoGlanceStateDefinition` (ë³µì¡í•œ ë°ì´í„°)
- **êµ¬ì¡°í™”ëœ ë°ì´í„°**ì— ì í•©
- Protocol Buffers ì‚¬ìš©
- íƒ€ì… ì•ˆì •ì„± â†‘, ì§ë ¬í™” ì„±ëŠ¥ â†‘

** Proto ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ â†’ [[6.2 Proto StateDefinition]]** ì°¸ê³ 

---

## 3. ìƒíƒœ ì½ê¸°

### 3.1 currentState()
```kotlin
override suspend fun provideGlance(context: Context, id: GlanceId) {
    provideContent {
        // Preferences ë°©ì‹
        val prefs = currentState<Preferences>()
        val value = prefs[intPreferencesKey("my_key")] ?: 0

        // Proto ë°©ì‹
        val state = currentState<WidgetState>()
        val title = state.title

        Text("Value: $value, Title: $title")
    }
}
```

> [!NOTE] 
> "`currentState()`ëŠ” ìœ„ì ¯ì˜ í˜„ì¬ ìƒíƒœë¥¼ ì½ì–´ì˜¤ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
>
> Preferences ë°©ì‹ì„ ì“°ë©´ `Preferences` íƒ€ì…ì„ ë°›ê³ , `intPreferencesKey`ë‚˜ `stringPreferencesKey`ë¡œ ê°’ì„ êº¼ëƒ…ë‹ˆë‹¤. Proto ë°©ì‹ì€ ì§ì ‘ ì •ì˜í•œ ë°ì´í„° í´ë˜ìŠ¤ë¥¼ ë°›ì•„ì„œ í”„ë¡œí¼í‹°ë¡œ ì ‘ê·¼í•©ë‹ˆë‹¤.
>
> ì¤‘ìš”í•œ ê±´, ì´ ìƒíƒœëŠ” **ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ë³„ë¡œ ë…ë¦½ì **ì´ë¼ëŠ” ì ì…ë‹ˆë‹¤. ê°™ì€ ìœ„ì ¯ì„ 3ê°œ ì¶”ê°€í•˜ë©´ ê°ê° ë‹¤ë¥¸ `GlanceId`ë¥¼ ê°–ê³ , ê°ìì˜ ìƒíƒœë¥¼ ë”°ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.
>
> Composeì˜ `remember`ì™€ ë¹„ìŠ·í•˜ì§€ë§Œ, DataStore ê¸°ë°˜ì´ë¼ **í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ í›„ì—ë„ ìœ ì§€**ë©ë‹ˆë‹¤."

---

### 3.2 ì¸ìŠ¤í„´ìŠ¤ë³„ ìƒíƒœ ìë™ ê´€ë¦¬ ì›ë¦¬

> [!QUESTION] ğŸ¤” ìì£¼ í•˜ëŠ” ì§ˆë¬¸
> **Q**: ìƒíƒœë¥¼ **ì“¸ ë•Œ**ëŠ” `updateAppWidgetState(context, glanceId)`ì²˜ëŸ¼ `glanceId`ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ”ë°, **ì½ì„ ë•Œ**ëŠ” `currentState()`ì— `glanceId`ë¥¼ ì „ë‹¬í•˜ì§€ ì•ŠëŠ”ë° ì–´ë–»ê²Œ ìë™ìœ¼ë¡œ ì¸ìŠ¤í„´ìŠ¤ë³„ ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ë‚˜ìš”?

**A**: Glance í”„ë ˆì„ì›Œí¬ê°€ **Composition Contextì— GlanceIdë¥¼ ìë™ ì£¼ì…**í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

#### 3.2.1 ë‚´ë¶€ ë™ì‘ ì›ë¦¬

**Step 1: provideGlanceì˜ id íŒŒë¼ë¯¸í„°**

```kotlin
override suspend fun provideGlance(context: Context, id: GlanceId) {
    //                                              â†‘ ì´ë¯¸ GlanceIdë¥¼ ë°›ê³  ìˆìŒ!
    provideContent {
        // ì´ ë¸”ë¡ ë‚´ë¶€ëŠ” íŠ¹ì • GlanceIdì˜ "Composition Context"ì—ì„œ ì‹¤í–‰ë¨
        val prefs = currentState<Preferences>()
    }
}
```

- `provideGlance`ëŠ” **ì‹œìŠ¤í…œì´ í˜¸ì¶œ**í•˜ëŠ” í•¨ìˆ˜ë¡œ, ì´ë¯¸ `id: GlanceId` íŒŒë¼ë¯¸í„°ë¡œ **ì–´ë–¤ ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê·¸ë ¤ì•¼ í•˜ëŠ”ì§€** ì•Œë ¤ì¤ë‹ˆë‹¤.
- `provideContent { }` ë¸”ë¡ì€ ì´ `id`ë¥¼ **ë‚´ë¶€ì ìœ¼ë¡œ Composition Contextì— ì €ì¥**í•©ë‹ˆë‹¤.

**Step 2: currentState()ì˜ ìë™ ì¶”ë¡ **

```kotlin
// currentState() ê°œë…ì  ë™ì‘ (ì˜ì‚¬ì½”ë“œ)
@Composable
fun <T> currentState(): T {
    // 1. ì»´í¬ì§€ì…˜ ì»¨í…ìŠ¤íŠ¸ì— ë°”ì¸ë”©ëœ í˜„ì¬ GlanceId ì‹ë³„
    //    (GlanceëŠ” LocalGlanceId ê°™ì€ CompositionLocalì„ í†µí•´ ì œê³µ)
    val glanceId = /* í˜„ì¬ ì»´í¬ì§€ì…˜ì˜ GlanceId */

    // 2. í•´ë‹¹ GlanceIdì— ë§¤í•‘ëœ DataStoreì—ì„œ ìƒíƒœ ì½ê¸°
    val dataStore = stateDefinition.getDataStore(context, glanceId)

    // 3. ìƒíƒœ ë°˜í™˜
    return dataStore.data.first()
}
```

- `currentState()`ëŠ” `@Composable` í•¨ìˆ˜ë¡œ, **ì»´í¬ì§€ì…˜ ì»¨í…ìŠ¤íŠ¸ì— ë°”ì¸ë”©ëœ í˜„ì¬ GlanceId**ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒíƒœ ì €ì¥ì†Œë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
- GlanceëŠ” `LocalGlanceId` ê°™ì€ CompositionLocalì„ í†µí•´ í˜„ì¬ ë Œë”ë§ ì¤‘ì¸ ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤.
- ë”°ë¼ì„œ **ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬í•˜ì§€ ì•Šì•„ë„** ìë™ìœ¼ë¡œ ì˜¬ë°”ë¥¸ ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ì˜ ìƒíƒœë¥¼ ì½ìŠµë‹ˆë‹¤.

**Step 3: ê° ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ëŠ” ë³„ë„ DataStore íŒŒì¼ ì‚¬ìš©**

```kotlin
// ê°œë…ì  íŒŒì¼ ì‹œìŠ¤í…œ êµ¬ì¡° (ì‹¤ì œ íŒŒì¼ëª…ì€ êµ¬í˜„ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
/data/data/com.example.app/files/datastore/
â”œâ”€â”€ [ì¸ìŠ¤í„´ìŠ¤ Aì˜ ê³ ìœ  íŒŒì¼]  // GlanceId A â†’ fileKey A
â”œâ”€â”€ [ì¸ìŠ¤í„´ìŠ¤ Bì˜ ê³ ìœ  íŒŒì¼]  // GlanceId B â†’ fileKey B
â””â”€â”€ [ì¸ìŠ¤í„´ìŠ¤ Cì˜ ê³ ìœ  íŒŒì¼]  // GlanceId C â†’ fileKey C
```

- `GlanceStateDefinition`ì€ ê° `GlanceId`ë¥¼ ì¸ìŠ¤í„´ìŠ¤ ê³ ìœ ì˜ `fileKey`ë¡œ ë§¤í•‘í•©ë‹ˆë‹¤.
- `getDataStore(context, fileKey)`ì™€ `getLocation(context, fileKey)`ë¥¼ í†µí•´ ì¸ìŠ¤í„´ìŠ¤ë³„ ë³„ë„ DataStore íŒŒì¼ì„ ìƒì„±/ì¡°íšŒí•©ë‹ˆë‹¤.
- ë”°ë¼ì„œ ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ë³„ë¡œ **ì™„ì „íˆ ë…ë¦½ì ì¸ ìƒíƒœ ì €ì¥ì†Œ**ë¥¼ ê°–ìŠµë‹ˆë‹¤.

> [!NOTE] ğŸ“ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­
> ì‹¤ì œ íŒŒì¼ëª…ì´ë‚˜ ê²½ë¡œ í˜•ì‹ì€ Glance ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> ì¤‘ìš”í•œ ê²ƒì€ **ê° ì¸ìŠ¤í„´ìŠ¤ê°€ ê³ ìœ í•œ ì €ì¥ì†Œë¥¼ ê°–ëŠ”ë‹¤**ëŠ” API ìˆ˜ì¤€ì˜ ë³´ì¥ì…ë‹ˆë‹¤.

#### 3.2.2 ì™œ ì“¸ ë•ŒëŠ” glanceIdë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬í•´ì•¼ í•˜ë‚˜?

> [!NOTE] ğŸ’¡ ì˜ˆì œ 2ì˜ ì´ˆì 
> ì´ ì˜ˆì œëŠ” **Composable ë¸”ë¡ ì™¸ë¶€ì—ì„œì˜ ë™ì‘ ì›ë¦¬**ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤:
> - ActionCallback/WorkerëŠ” Composition Contextê°€ ì—†ìŒ
> - ë”°ë¼ì„œ GlanceIdë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬í•´ì•¼ í•¨
> - ì‹œìŠ¤í…œì´ ì–´ë–¤ ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í• ì§€ ëª…í™•íˆ ì§€ì •

```kotlin
// âŒ provideContent ì™¸ë¶€ì—ì„œëŠ” Composition Contextê°€ ì—†ìŒ
class IncrementAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,  // ActionCallbackì´ ì œê³µ
        parameters: ActionParameters
    ) {
        // ì—¬ê¸°ëŠ” Composable ë¸”ë¡ì´ ì•„ë‹ˆë¯€ë¡œ LocalGlanceId.currentë¥¼ ì“¸ ìˆ˜ ì—†ìŒ!
        // ë”°ë¼ì„œ ëª…ì‹œì ìœ¼ë¡œ glanceIdë¥¼ ì „ë‹¬í•´ì•¼ í•¨
        updateAppWidgetState(context, glanceId) { prefs ->
            //                           â†‘ í•„ìˆ˜!
            prefs[intPreferencesKey("count")] = 42
        }
    }
}

// âŒ Workerì—ì„œë„ ë§ˆì°¬ê°€ì§€
class DataSyncWorker : CoroutineWorker(...) {
    override suspend fun doWork(): Result {
        // WorkerëŠ” ìœ„ì ¯ ì™¸ë¶€ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ Composition Contextê°€ ì—†ìŒ
        val manager = GlanceAppWidgetManager(applicationContext)
        val glanceIds = manager.getGlanceIds(MyWidget::class.java)

        glanceIds.forEach { glanceId ->
            updateAppWidgetState(applicationContext, glanceId) { prefs ->
                //                                     â†‘ ëª…ì‹œì  ì „ë‹¬ í•„ìˆ˜
                prefs[stringPreferencesKey("data")] = "updated"
            }
        }
        return Result.success()
    }
}
```

**ì´ìœ **:
- `ActionCallback`ì´ë‚˜ `Worker`ëŠ” **ìœ„ì ¯ ì™¸ë¶€**ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.
- **Composable Contextê°€ ì—†ìœ¼ë¯€ë¡œ** `LocalGlanceId.current`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
- ë”°ë¼ì„œ `updateAppWidgetState(context, glanceId)`ì²˜ëŸ¼ **ëª…ì‹œì ìœ¼ë¡œ ì–´ë–¤ ìœ„ì ¯ì˜ ìƒíƒœë¥¼ ë³€ê²½í• ì§€** ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.

#### 3.2.3 ë¹„êµ: ì½ê¸° vs ì“°ê¸°

| ìƒí™© | ìœ„ì¹˜ | GlanceId ì „ë‹¬ | ì´ìœ  |
|------|------|--------------|------|
| **ìƒíƒœ ì½ê¸°** | `provideContent { }` ë‚´ë¶€ | âŒ ë¶ˆí•„ìš” | Composition Contextì—ì„œ ìë™ ì¶”ë¡  |
| **ìƒíƒœ ì“°ê¸°** | `ActionCallback`, `Worker` | âœ… í•„ìˆ˜ | Composable ë¸”ë¡ ì™¸ë¶€ë¼ì„œ ëª…ì‹œ í•„ìš” |

#### 3.2.4 ì‹¤ì „ ì˜ˆì œ: ì „ì²´ íë¦„

> [!NOTE] ğŸ’¡ ì˜ˆì œ 3ì˜ ì´ˆì 
> ì´ ì˜ˆì œëŠ” **ì‹œìŠ¤í…œ ì „ì²´ íë¦„ì˜ ì´í•´**ë¥¼ ë•ìŠµë‹ˆë‹¤:
> - ì‹œìŠ¤í…œì´ GlanceIdë¥¼ ì–´ë–»ê²Œ ì „ë‹¬í•˜ëŠ”ì§€
> - provideContent ë‚´ë¶€(ì½ê¸°)ì™€ ActionCallback(ì“°ê¸°)ì˜ ì°¨ì´
> - ìƒíƒœ ë³€ê²½ â†’ UI ì—…ë°ì´íŠ¸ì˜ ì™„ì „í•œ ì‚¬ì´í´

```kotlin
// 1. ì‹œìŠ¤í…œì´ ìœ„ì ¯ì„ ë Œë”ë§í•  ë•Œ
class MyWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        //                                              â†‘ ì‹œìŠ¤í…œì´ ì œê³µ (ì˜ˆ: id=123)

        // 2. provideContent ë¸”ë¡ì€ id=123ì˜ Contextì—ì„œ ì‹¤í–‰
        provideContent {
            // 3. currentState()ëŠ” ìë™ìœ¼ë¡œ id=123ì˜ ìƒíƒœë¥¼ ì½ìŒ
            val prefs = currentState<Preferences>()
            //          â†‘ ì»´í¬ì§€ì…˜ ì»¨í…ìŠ¤íŠ¸ì—ì„œ GlanceId=123 ìë™ ì‹ë³„
            //          â†‘ í•´ë‹¹ ì¸ìŠ¤í„´ìŠ¤ì˜ DataStore íŒŒì¼ ì½ê¸°

            val count = prefs[intPreferencesKey("count")] ?: 0

            Text("Count: $count")
            Button("ì¦ê°€", onClick = actionRunCallback<IncrementAction>())
        }
    }
}

// 4. ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´
class IncrementAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,  // ì‹œìŠ¤í…œì´ ì œê³µ (ì˜ˆ: glanceId=123)
        parameters: ActionParameters
    ) {
        // 5. ì—¬ê¸°ëŠ” Composable ë¸”ë¡ì´ ì•„ë‹ˆë¯€ë¡œ glanceIdë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬
        updateAppWidgetState(context, glanceId) { prefs ->
            //                           â†‘ í•„ìˆ˜! (glanceId=123)
            //                           â†‘ í•´ë‹¹ ì¸ìŠ¤í„´ìŠ¤ì˜ DataStore íŒŒì¼ì— ì“°ê¸°
            val current = prefs[intPreferencesKey("count")] ?: 0
            prefs[intPreferencesKey("count")] = current + 1
        }

        // 6. UI ì—…ë°ì´íŠ¸ â†’ ë‹¤ì‹œ provideGlance(id=123) í˜¸ì¶œ
        MyWidget().update(context, glanceId)
    }
}
```

> [!TIP] ğŸ’¡ í•µì‹¬ ì •ë¦¬
> **ì½ê¸° (provideContent ë‚´ë¶€)**:
> - âœ… `currentState()`ë¡œ ìë™ ì¶”ë¡ 
> - âœ… ì»´í¬ì§€ì…˜ ì»¨í…ìŠ¤íŠ¸ì— ë°”ì¸ë”©ëœ GlanceIdë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒíƒœ ì¡°íšŒ
> - âœ… ê°œë°œìê°€ GlanceIdë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬í•  í•„ìš” ì—†ìŒ
>
> **ì“°ê¸° (ActionCallback, Worker ë“± ì™¸ë¶€)**:
> - âœ… `updateAppWidgetState(context, glanceId)`ë¡œ ëª…ì‹œì  ì „ë‹¬ í•„ìˆ˜
> - âœ… Composable ë¸”ë¡ ì™¸ë¶€ì—ì„œëŠ” ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ìë™ ì¶”ë¡  ë¶ˆê°€
> - âœ… ì–´ë–¤ ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í• ì§€ ëª…í™•í•˜ê²Œ ì§€ì •
>
> **ê²°ë¡ **: GlanceëŠ” **CompositionLocal(ì˜ˆ: LocalGlanceId)** ê°™ì€ ë©”ì»¤ë‹ˆì¦˜ì„ í™œìš©í•´ `provideContent` ë‚´ë¶€ì—ì„œëŠ” GlanceIdë¥¼ ìë™ ê´€ë¦¬í•˜ê³ , ì™¸ë¶€ì—ì„œëŠ” ëª…ì‹œì  ì „ë‹¬ì„ ìš”êµ¬í•˜ì—¬ **íƒ€ì… ì•ˆì •ì„±ê³¼ í¸ì˜ì„±ì„ ë™ì‹œì—** ì œê³µí•©ë‹ˆë‹¤.

---

## 4. ìƒíƒœ ì“°ê¸°

### 4.1 updateAppWidgetState (ë‹¨ì¼ ìœ„ì ¯)

> [!NOTE] ğŸ’¡ ì˜ˆì œ 4ì˜ ì´ˆì 
> ì´ ì˜ˆì œëŠ” **updateAppWidgetState APIì˜ ìƒì„¸ ì‚¬ìš©ë²•**ì„ ì„¤ëª…í•©ë‹ˆë‹¤:
> - Preferences ë°©ì‹ê³¼ Proto ë°©ì‹ì˜ ì°¨ì´
> - ìƒíƒœ ë³€ê²½ í›„ ë°˜ë“œì‹œ update() í˜¸ì¶œ í•„ìš”
> - PreferencesëŠ” mutable, ProtoëŠ” ë¶ˆë³€ ê°ì²´ (ë¹Œë” íŒ¨í„´)

```kotlin
class IncrementAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // Preferences ë°©ì‹
        updateAppWidgetState(context, glanceId) { prefs ->
            val current = prefs[intPreferencesKey("count")] ?: 0
            prefs[intPreferencesKey("count")] = current + 1
        }

        // Proto ë°©ì‹ (ë³µì‚¬ í›„ ìˆ˜ì •)
        updateAppWidgetState(context, glanceId) { state: WidgetState ->
            state.toBuilder()
                .setCounter(state.counter + 1)
                .build()
        }

        // ë°˜ë“œì‹œ update() í˜¸ì¶œ!
        MyWidget().update(context, glanceId)
    }
}
```

> [!NOTE] 
> "ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” íë¦„ì€ **2ë‹¨ê³„**ì…ë‹ˆë‹¤.
>
> 1. **`updateAppWidgetState`ë¡œ ìƒíƒœ ë³€ê²½**: ëŒë‹¤ ì•ˆì—ì„œ ê¸°ì¡´ ê°’ì„ ì½ê³ , ìƒˆ ê°’ì„ ì„¤ì •í•©ë‹ˆë‹¤. Preferences ë°©ì‹ì€ mutableí•˜ê²Œ ì§ì ‘ ìˆ˜ì •í•˜ê³ , Proto ë°©ì‹ì€ ë¶ˆë³€ ê°ì²´ë¼ì„œ ë¹Œë”ë¡œ ë³µì‚¬ í›„ ìˆ˜ì •í•©ë‹ˆë‹¤.
>
> 2. **`update()` í˜¸ì¶œë¡œ UI ê°±ì‹ **: ìƒíƒœë§Œ ë°”ê¿”ì„œëŠ” í™”ë©´ì´ ì•ˆ ë°”ë€ë‹ˆë‹¤. ë°˜ë“œì‹œ `MyWidget().update(context, glanceId)`ë¥¼ í˜¸ì¶œí•´ì•¼ `provideContent`ê°€ ë‹¤ì‹œ ì‹¤í–‰ë˜ê³  UIê°€ ìƒˆë¡œ ê·¸ë ¤ì§‘ë‹ˆë‹¤.
>
> ì´ ë‘ ë‹¨ê³„ë¥¼ ë¹¼ë¨¹ìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤. ìƒíƒœëŠ” ë°”ë€Œì—ˆëŠ”ë° í™”ë©´ì€ ê·¸ëŒ€ë¡œê±°ë‚˜, ìƒíƒœëŠ” ê·¸ëŒ€ë¡œì¸ë° UIë§Œ ë‹¤ì‹œ ê·¸ë ¤ì§€ëŠ” ìƒí™©ì´ ìƒê¸¸ ìˆ˜ ìˆì–´ìš”."

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** ìƒíƒœ ë³€ê²½ ì „í›„ ë¹„êµ (ì¹´ìš´í„° 0 â†’ 1)

---

### 4.2 updateAll (ëª¨ë“  ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤)
```kotlin
class RefreshAllAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // ëª¨ë“  ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ì˜ ìƒíƒœë¥¼ ë™ì¼í•˜ê²Œ ë³€ê²½
        val manager = GlanceAppWidgetManager(context)
        val glanceIds = manager.getGlanceIds(MyWidget::class.java)

        glanceIds.forEach { id ->
            updateAppWidgetState(context, id) { prefs ->
                prefs[longPreferencesKey("last_sync")] = System.currentTimeMillis()
            }
        }

        // ëª¨ë“  ìœ„ì ¯ UI ê°±ì‹ 
        MyWidget().updateAll(context)
    }
}
```

---

## 5. ì‹¤ì „ íŒ¨í„´(ìƒëµ)

### 5.1 ì´ˆê¸° ìƒíƒœ ì„¤ì •
```kotlin
class MyWidgetReceiver : GlanceAppWidgetReceiver() {
    override val glanceAppWidget = MyWidget()

    override fun onUpdate(
        context: Context,
        appWidgetManager: AppWidgetManager,
        appWidgetIds: IntArray
    ) {
        super.onUpdate(context, appWidgetManager, appWidgetIds)

        // ê° ìœ„ì ¯ ì¸ìŠ¤í„´ìŠ¤ì— ì´ˆê¸° ìƒíƒœ ì„¤ì •
        appWidgetIds.forEach { appWidgetId ->
            val glanceId = GlanceAppWidgetManager(context)
                .getGlanceIdBy(appWidgetId)

            lifecycleScope.launch {
                updateAppWidgetState(context, glanceId) { prefs ->
                    if (!prefs.contains(intPreferencesKey("count"))) {
                        prefs[intPreferencesKey("count")] = 0
                    }
                    prefs[longPreferencesKey("created_at")] = System.currentTimeMillis()
                }
                MyWidget().update(context, glanceId)
            }
        }
    }
}
```

---

### 5.2 ì™¸ë¶€ ë°ì´í„°ì™€ ë™ê¸°í™” (Repository íŒ¨í„´)
```kotlin
class DataSyncWorker(
    context: Context,
    params: WorkerParameters
) : CoroutineWorker(context, params) {

    override suspend fun doWork(): Result {
        // 1. API í˜¸ì¶œ
        val data = apiService.fetchData()

        // 2. ëª¨ë“  ìœ„ì ¯ ìƒíƒœ ì—…ë°ì´íŠ¸
        val manager = GlanceAppWidgetManager(applicationContext)
        val glanceIds = manager.getGlanceIds(MyWidget::class.java)

        glanceIds.forEach { glanceId ->
            updateAppWidgetState(applicationContext, glanceId) { prefs ->
                prefs[stringPreferencesKey("data")] = data.toString()
                prefs[longPreferencesKey("last_update")] = System.currentTimeMillis()
            }
        }

        // 3. UI ê°±ì‹ 
        MyWidget().updateAll(applicationContext)

        return Result.success()
    }
}
```

**[ë¹„ë””ì˜¤ ì¶”ì²œ]** Worker ì‹¤í–‰ â†’ API í˜¸ì¶œ â†’ ìœ„ì ¯ ìƒíƒœ ë³€ê²½ â†’ UI ìë™ ê°±ì‹  íë¦„

---

### 5.3 ì¡°ê±´ë¶€ ìƒíƒœ ë³€ê²½
```kotlin
class ToggleAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        updateAppWidgetState(context, glanceId) { prefs ->
            val isEnabled = prefs[booleanPreferencesKey("is_enabled")] ?: false

            if (isEnabled) {
                // ë¹„í™œì„±í™”
                prefs[booleanPreferencesKey("is_enabled")] = false
                prefs[stringPreferencesKey("status")] = "OFF"
            } else {
                // í™œì„±í™”
                prefs[booleanPreferencesKey("is_enabled")] = true
                prefs[stringPreferencesKey("status")] = "ON"
                prefs[longPreferencesKey("enabled_at")] = System.currentTimeMillis()
            }
        }

        MyWidget().update(context, glanceId)
    }
}
```

---

### 5.4 ìƒíƒœ ê¸°ë°˜ UI ë¶„ê¸°
```kotlin
override suspend fun provideGlance(context: Context, id: GlanceId) {
    provideContent {
        val prefs = currentState<Preferences>()
        val status = prefs[stringPreferencesKey("status")] ?: "idle"

        when (status) {
            "loading" -> LoadingUI()
            "success" -> SuccessUI(prefs)
            "error" -> ErrorUI(prefs[stringPreferencesKey("error_msg")])
            else -> IdleUI()
        }
    }
}

@Composable
fun LoadingUI() {
    Box(
        modifier = GlanceModifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        CircularProgressIndicator()
        Text("ë¡œë”© ì¤‘...")
    }
}

@Composable
fun SuccessUI(prefs: Preferences) {
    val data = prefs[stringPreferencesKey("data")] ?: ""
    Column {
        Text("ì„±ê³µ!", style = TextStyle(fontWeight = FontWeight.Bold))
        Text(data)
    }
}

@Composable
fun ErrorUI(message: String?) {
    Column {
        Text("ì˜¤ë¥˜ ë°œìƒ", style = TextStyle(color = ColorProvider(Color.Red)))
        Text(message ?: "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜")
        Button("ì¬ì‹œë„", onClick = actionRunCallback<RetryAction>())
    }
}
```

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** ìƒíƒœë³„ UI ë³€í™” (idle, loading, success, error)

---

## 6. ìƒíƒœ ê´€ë¦¬ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### âœ… DO
- **ì‘ì€ ë°ì´í„°ë§Œ ì €ì¥** (ìˆ˜ì‹­ KB ì´ë‚´)
- **ìƒíƒœ ë³€ê²½ í›„ ì¦‰ì‹œ update() í˜¸ì¶œ**
- **ê¸°ë³¸ê°’ ì œê³µ** (?: 0, ?: "default")
- **ì¸ìŠ¤í„´ìŠ¤ë³„ ë…ë¦½ì„± ìœ ì§€** (GlanceId í™œìš©)
- **ë¬´ê±°ìš´ ë°ì´í„°ëŠ” ì™¸ë¶€ ì €ì¥ì†Œ**(Room, File) + Glanceì—ëŠ” IDë§Œ ì €ì¥

### âŒ DON'T
- **ëŒ€ìš©ëŸ‰ ë°ì´í„° ì €ì¥ ê¸ˆì§€** (ì´ë¯¸ì§€, ê¸´ í…ìŠ¤íŠ¸)
- **ìƒíƒœ ë³€ê²½ë§Œ í•˜ê³  update() ìƒëµ**
- **ë™ê¸°í™” ë¸”ë¡œí‚¹ ì‘ì—…** (ë„¤íŠ¸ì›Œí¬, DB)
- **ìƒíƒœì— ë¯¼ê° ì •ë³´ ì €ì¥** (í† í°, ë¹„ë°€ë²ˆí˜¸)

---

## 7. ì‹¤ì „ ì˜ˆì œ: ë‚ ì”¨ ìœ„ì ¯

```kotlin
data class WeatherData(
    val temperature: Int,
    val condition: String,
    val lastUpdate: Long
)

class WeatherWidget : GlanceAppWidget() {
    override val stateDefinition = PreferencesGlanceStateDefinition

    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            val prefs = currentState<Preferences>()
            val temp = prefs[intPreferencesKey("temperature")] ?: 0
            val condition = prefs[stringPreferencesKey("condition")] ?: "ì•Œ ìˆ˜ ì—†ìŒ"
            val isLoading = prefs[booleanPreferencesKey("is_loading")] ?: false
            val lastUpdate = prefs[longPreferencesKey("last_update")] ?: 0L

            Column(
                modifier = GlanceModifier
                    .fillMaxSize()
                    .padding(16.dp)
                    .background(Color.LightGray)
            ) {
                if (isLoading) {
                    Text("ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ì¤‘...")
                    CircularProgressIndicator()
                } else {
                    Text("ğŸŒ¤ï¸ $condition", style = TextStyle(fontSize = 24.sp))
                    Text("$tempÂ°C", style = TextStyle(fontSize = 48.sp, fontWeight = FontWeight.Bold))

                    Spacer(GlanceModifier.height(8.dp))

                    Text(
                        "ìµœê·¼ ì—…ë°ì´íŠ¸: ${formatTime(lastUpdate)}",
                        style = TextStyle(fontSize = 12.sp, color = ColorProvider(Color.Gray))
                    )
                }

                Spacer(GlanceModifier.defaultWeight())

                Button(
                    text = "ìƒˆë¡œê³ ì¹¨",
                    onClick = actionRunCallback<RefreshWeatherAction>(),
                    modifier = GlanceModifier.fillMaxWidth()
                )
            }
        }
    }
}

class RefreshWeatherAction : ActionCallback {
    override suspend fun onAction(
        context: Context,
        glanceId: GlanceId,
        parameters: ActionParameters
    ) {
        // 1. ë¡œë”© ìƒíƒœë¡œ ë³€ê²½
        updateAppWidgetState(context, glanceId) { prefs ->
            prefs[booleanPreferencesKey("is_loading")] = true
        }
        WeatherWidget().update(context, glanceId)

        // 2. Workerë¡œ ë‚ ì”¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë¹„ë™ê¸°)
        val workRequest = OneTimeWorkRequestBuilder<WeatherWorker>()
            .setInputData(workDataOf("glance_id" to glanceId.toString()))
            .build()
        WorkManager.getInstance(context).enqueue(workRequest)
    }
}

class WeatherWorker(context: Context, params: WorkerParameters) : CoroutineWorker(context, params) {
    override suspend fun doWork(): Result {
        val glanceIdString = inputData.getString("glance_id") ?: return Result.failure()
        val glanceId = GlanceAppWidgetManager(applicationContext)
            .getGlanceIds(WeatherWidget::class.java)
            .find { it.toString() == glanceIdString }
            ?: return Result.failure()

        try {
            // API í˜¸ì¶œ
            val weather = weatherApi.getCurrentWeather()

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            updateAppWidgetState(applicationContext, glanceId) { prefs ->
                prefs[intPreferencesKey("temperature")] = weather.temp
                prefs[stringPreferencesKey("condition")] = weather.condition
                prefs[longPreferencesKey("last_update")] = System.currentTimeMillis()
                prefs[booleanPreferencesKey("is_loading")] = false
            }

            // UI ê°±ì‹ 
            WeatherWidget().update(applicationContext, glanceId)

            return Result.success()
        } catch (e: Exception) {
            // ì—ëŸ¬ ìƒíƒœ ì €ì¥
            updateAppWidgetState(applicationContext, glanceId) { prefs ->
                prefs[booleanPreferencesKey("is_loading")] = false
                prefs[stringPreferencesKey("condition")] = "ì˜¤ë¥˜"
            }
            WeatherWidget().update(applicationContext, glanceId)

            return Result.failure()
        }
    }
}
```

**[ìŠ¤í¬ë¦°ìƒ· ì¶”ì²œ]** ë‚ ì”¨ ìœ„ì ¯ ì „ì²´ UI (ì˜¨ë„, ë‚ ì”¨ ìƒíƒœ, ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„, ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼)

---